---
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import Analytics from "@vercel/analytics/astro";
import ChatButton from "../components/ChatButton.astro";
import { supabase } from "../lib/supabase";

export interface Props {
    title: string;
    description?: string;
    image?: string;
    keywords?: string;
    author?: string;
    canonical?: string;
    ogType?: string;
    publishedTime?: string;
    modifiedTime?: string;
    noindex?: boolean;
    showChatButton?: boolean;
    projects?: Array<{
        "@type": string;
        name: string;
        description: string;
        url?: string;
        author: {
            "@type": string;
            name: string;
        };
        keywords?: string;
        codeRepository?: string;
    }>;
}

const {
    title,
    description = "",
    image = "/og-image.jpg",
    keywords = "",
    author,
    canonical,
    ogType = "website",
    publishedTime,
    modifiedTime,
    noindex = false,
    showChatButton = false,
    projects = [],
} = Astro.props;

// Fetch personal info for structured data
const { data: personalInfo } = await supabase
    .from("personal_info")
    .select(
        "full_name, github_username, email, linkedin_url, seo_description, seo_keywords, job_title, og_image_url",
    )
    .single();

// Fetch skills
const { data: skills } = await supabase
    .from("skills")
    .select("name")
    .eq("is_active", true)
    .order("order", { ascending: true });

// Fetch education/alumni info
const { data: education } = await supabase
    .from("education")
    .select("institution, field_of_study")
    .eq("is_active", true)
    .limit(1)
    .single();

const siteAuthor = personalInfo?.full_name || "Developer";
const siteDescription = description || personalInfo?.seo_description || "";
const siteKeywords = keywords || personalInfo?.seo_keywords || "";
const siteEmail = personalInfo?.email || "contact@example.com";
const linkedinUrl = personalInfo?.linkedin_url || "https://www.linkedin.com/";
const githubUsername = personalInfo?.github_username || "username";
const githubUrl = `https://github.com/${githubUsername}`;
const jobTitle = personalInfo?.job_title || "Developer";
const ogImageUrl = personalInfo?.og_image_url || "/og-image.jpg";
const skillsList = skills?.map((s) => s.name) || [];
const alumniInstitution = education?.institution || "University";
const fieldOfStudy = education?.field_of_study || "Computer Science";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Google Search Console verification from environment variable
const googleVerification = import.meta.env.GOOGLE_VERIFICATION_CODE;

// Get the full URL for Open Graph and canonical
const currentUrl = new URL(
    Astro.url.pathname,
    Astro.site || "https://gonzalez.dev.br",
);
const canonicalUrl = canonical
    ? new URL(canonical, Astro.site || "https://gonzalez.dev.br")
    : currentUrl;
const imageUrl = new URL(ogImageUrl, Astro.site || "https://gonzalez.dev.br");

// Generate hreflang URLs
const baseUrl = Astro.site || "https://gonzalez.dev.br";
const currentPath = Astro.url.pathname;
const isDefaultLang = lang === "en";
const pathWithoutLang = isDefaultLang
    ? currentPath
    : currentPath.replace(`/${lang}`, "") || "/";

const hreflangs = [
    { lang: "en", url: pathWithoutLang },
    {
        lang: "fr",
        url: pathWithoutLang === "/" ? "/fr/" : `/fr${pathWithoutLang}`,
    },
    {
        lang: "pt",
        url: pathWithoutLang === "/" ? "/pt/" : `/pt${pathWithoutLang}`,
    },
];

// Additional hreflang entries for specific geographic targeting
const additionalHreflangs = [
    { lang: "en-US", url: pathWithoutLang }, // English - United States
    { lang: "en-CA", url: pathWithoutLang }, // English - Canada
    {
        lang: "fr-FR",
        url: pathWithoutLang === "/" ? "/fr/" : `/fr${pathWithoutLang}`,
    }, // French - France
    {
        lang: "fr-CA",
        url: pathWithoutLang === "/" ? "/fr/" : `/fr${pathWithoutLang}`,
    }, // French - Canada
    {
        lang: "pt-BR",
        url: pathWithoutLang === "/" ? "/pt/" : `/pt${pathWithoutLang}`,
    }, // Portuguese - Brazil
    {
        lang: "pt-PT",
        url: pathWithoutLang === "/" ? "/pt/" : `/pt${pathWithoutLang}`,
    }, // Portuguese - Portugal
];
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content={Astro.generator} />

        <!-- Primary Meta Tags -->
        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={siteDescription} />
        <meta name="keywords" content={siteKeywords} />
        <meta name="author" content={siteAuthor} />
        <meta
            name="robots"
            content={noindex ? "noindex, nofollow" : "index, follow"}
        />
        <meta name="language" content={lang} />

        <!-- Canonical URL -->
        <link rel="canonical" href={canonicalUrl.href} />

        <!-- Hreflang for internationalization -->
        {
            hreflangs.map(({ lang: hreflang, url }) => (
                <link
                    rel="alternate"
                    hreflang={hreflang}
                    href={new URL(url, baseUrl).href}
                />
            ))
        }

        <link
            rel="alternate"
            hreflang="x-default"
            href={new URL(pathWithoutLang, baseUrl).href}
        />

        <!-- Additional geographic-specific hreflang tags -->
        {
            additionalHreflangs.map(({ lang: hreflang, url }) => (
                <link
                    rel="alternate"
                    hreflang={hreflang}
                    href={new URL(url, baseUrl).href}
                />
            ))
        }

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="apple-touch-icon" href="/favicon.svg" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={ogType} />
        <meta property="og:url" content={currentUrl.href} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={siteDescription} />
        <meta property="og:image" content={imageUrl.href} />
        <meta property="og:site_name" content={siteAuthor} />
        <meta
            property="og:locale"
            content={lang === "en"
                ? "en_US"
                : lang === "pt"
                  ? "pt_BR"
                  : "fr_FR"}
        />

        <!-- Additional locale alternatives for broader geographic targeting -->
        {
            lang === "en" && (
                <meta property="og:locale:alternate" content="en_CA" />
            )
        }
        {
            lang === "fr" && (
                <meta property="og:locale:alternate" content="fr_CA" />
            )
        }
        {
            lang === "pt" && (
                <meta property="og:locale:alternate" content="pt_PT" />
            )
        }

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={currentUrl.href} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={siteDescription} />
        <meta property="twitter:image" content={imageUrl.href} />
        <meta property="twitter:creator" content="@guilhermomg" />

        <!-- LinkedIn -->
        <meta property="article:author" content={author} />
        {
            ogType === "article" && publishedTime && (
                <meta
                    property="article:published_time"
                    content={publishedTime}
                />
            )
        }
        {
            ogType === "article" && modifiedTime && (
                <meta property="article:modified_time" content={modifiedTime} />
            )
        }

        <!-- Additional SEO Meta Tags -->
        <meta name="theme-color" content="#111827" />
        <meta name="msapplication-TileColor" content="#111827" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />

        <!-- Google Search Console Verification -->
        {
            googleVerification && (
                <meta
                    name="google-site-verification"
                    content={googleVerification}
                />
            )
        }

        <!-- Security Headers -->
        <meta http-equiv="X-Content-Type-Options" content="nosniff" />
        <meta http-equiv="X-Frame-Options" content="DENY" />
        <meta http-equiv="X-XSS-Protection" content="1; mode=block" />

        <!-- JSON-LD Structured Data -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": "Person",
                name: siteAuthor,
                jobTitle: jobTitle,
                description: siteDescription,
                url: "https://gonzalez.dev.br",
                sameAs: [linkedinUrl, githubUrl],
                knowsAbout: skillsList,
                alumniOf: {
                    "@type": "Organization",
                    name: alumniInstitution,
                },
                contactPoint: {
                    "@type": "ContactPoint",
                    email: siteEmail,
                    contactType: "professional",
                },
                ...(projects.length > 0 && {
                    workExample: projects,
                }),
            })}
        />
    </head>
    <body
        class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white font-sans"
    >
        <slot />
        <Analytics />
        {showChatButton && <ChatButton />}
    </body>
</html>

<style is:global>
    html {
        font-family: "Inter", system-ui, sans-serif;
    }

    * {
        scrollbar-width: thin;
        scrollbar-color: rgb(156 163 175) transparent;
    }

    *::-webkit-scrollbar {
        width: 6px;
    }

    *::-webkit-scrollbar-track {
        background: transparent;
    }

    *::-webkit-scrollbar-thumb {
        background-color: rgb(156 163 175);
        border-radius: 3px;
    }
</style>
