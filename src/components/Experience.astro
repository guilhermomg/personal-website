---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { createServerClient } from '../lib/supabase';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch experiences from database
const supabase = createServerClient(Astro.cookies);
const { data: experiencesData } = await supabase
  .from('experiences')
  .select('*')
  .eq('is_published', true)
  .order('start_year', { ascending: false })
  .order('start_month', { ascending: false })
  .order('end_year', { ascending: false })
  .order('end_month', { ascending: false });

// Helper function to get month name
const getMonthName = (month: number | null) => {
  if (!month) return '';
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  return months[month - 1] || '';
};

// Transform database experiences to component format
const experiences = (experiencesData || []).map(exp => ({
  title: exp.title,
  company: exp.company,
  startMonth: getMonthName(exp.start_month),
  startYear: exp.start_year?.toString() || '',
  endMonth: exp.end_month ? getMonthName(exp.end_month) : 'Present',
  endYear: exp.end_year?.toString() || '',
  location: exp.location || '',
  description: exp.description || [],
  technologies: exp.skills || []
}));
---

<section id="experience" class="py-20 bg-gray-50 dark:bg-gray-800">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16">
      <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4">
        {t('experience.title')}
      </h2>
      <div class="w-20 h-1 bg-primary-600 mx-auto mb-8"></div>
    </div>
    
    <div class="relative">
      <!-- Timeline line -->
      <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-primary-600 hidden md:block"></div>
      
      <div class="space-y-8">
        {experiences.map((exp, index) => (
          <div class="relative flex items-start space-x-8">
            <!-- Timeline dot -->
            <div class="hidden md:flex items-center justify-center w-16 h-16 bg-primary-600 rounded-full flex-shrink-0 relative z-10">
              <div class="w-8 h-8 bg-white rounded-full"></div>
            </div>
            
            <!-- Content -->
            <div class="flex-1 md:ml-0 ml-8">
              <div class="bg-white dark:bg-gray-900 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                  <div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                      {exp.title}
                    </h3>
                    <p class="text-lg text-primary-600 dark:text-primary-400 font-medium">
                      {exp.company}
                    </p>
                  </div>
                  <div class="text-sm text-gray-500 dark:text-gray-400 mt-2 sm:mt-0">
                    <div>
                      {exp.startMonth} {exp.startYear} - {exp.endYear ? `${exp.endMonth} ${exp.endYear}` : exp.endMonth}
                    </div>
                    {exp.location && <div>{exp.location}</div>}
                  </div>
                </div>
                
                <ul class="space-y-2 mb-6">
                  {exp.description.map((item: string) => (
                    <li class="flex items-start space-x-2 text-gray-600 dark:text-gray-400">
                      <svg class="w-4 h-4 text-primary-600 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                      <span>{item}</span>
                    </li>
                  ))}
                </ul>
                
                <div class="flex flex-wrap gap-2">
                  {exp.technologies.map((tech: string) => (
                    <span class="px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 text-sm rounded-full">
                      {tech}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</section>
