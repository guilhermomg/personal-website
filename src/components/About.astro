---
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { supabase } from "../lib/supabase";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch personal info translations from database
const { data: translations } = await supabase
    .from("personal_info_translations")
    .select("about_title, about_description")
    .eq("language_code", lang)
    .single();

// Fetch languages spoken
const { data: languagesSpoken } = await supabase
    .from("languages_spoken")
    .select("language_name, flag_emoji, proficiency_level")
    .order("order_index", { ascending: true });

// Fetch skill categories and skills from database
const { data: skillCategoriesData } = await supabase
    .from("skill_categories")
    .select(
        `
        id,
        name,
        sort_order,
        skills (
            id,
            sort_order,
            skill_translations (
                language_code,
                name
            )
        ),
        sub_categories:skill_categories!parent_category_id (
            id,
            name,
            sort_order,
            skills (
                id,
                sort_order,
                skill_translations (
                    language_code,
                    name
                )
            )
        )
    `,
    )
    .is("parent_category_id", null)
    .eq("is_active", true)
    .order("sort_order", { ascending: true });

// Transform database data to preserve subcategory hierarchy
type SkillCategory = {
    name: string;
    skills: string[];
    subcategories: Array<{
        name: string;
        skills: string[];
    }>;
};

const skillCategories: SkillCategory[] = [];

if (skillCategoriesData) {
    skillCategoriesData.forEach((category: any) => {
        // Get skills directly under this category
        const directSkills = (category.skills || [])
            .map((skill: any) => {
                const translation = skill.skill_translations?.find(
                    (t: any) => t.language_code === lang,
                );
                return translation?.name || skill.skill_translations?.[0]?.name;
            })
            .filter(Boolean);

        // Get subcategories with their skills
        const subcategories = (category.sub_categories || [])
            .sort((a: any, b: any) => (a.sort_order || 0) - (b.sort_order || 0))
            .map((subcat: any) => {
                const subcatSkills = (subcat.skills || [])
                    .map((skill: any) => {
                        const translation = skill.skill_translations?.find(
                            (t: any) => t.language_code === lang,
                        );
                        return (
                            translation?.name ||
                            skill.skill_translations?.[0]?.name
                        );
                    })
                    .filter(Boolean);

                return {
                    name: subcat.name,
                    skills: subcatSkills,
                };
            })
            .filter((subcat: any) => subcat.skills.length > 0);

        // Only add category if it has skills or subcategories with skills
        if (directSkills.length > 0 || subcategories.length > 0) {
            skillCategories.push({
                name: category.name,
                skills: directSkills,
                subcategories: subcategories,
            });
        }
    });
}

const aboutTitle = translations?.about_title || t("about.description");
const aboutDescription = translations?.about_description || "";
const aboutParagraphs = aboutDescription
    .split("\n\n")
    .filter((p: string) => p.trim());

// Map proficiency levels to translation keys
const proficiencyMap = {
    native: "about.language.native",
    fluent: "about.language.fluent",
    advanced: "about.language.advanced",
    beginner: "about.language.beginner",
} as const;
---

<section id="about" class="py-20 bg-white dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-16">
            <h2
                class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-4"
            >
                {t("about.title")}
            </h2>
            <div class="w-20 h-1 bg-primary-600 mx-auto mb-8"></div>
            <p
                class="max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400 leading-relaxed"
            >
                {aboutTitle}
            </p>
        </div>

        <div class="grid lg:grid-cols-2 gap-12 items-start">
            <!-- Text Content -->
            <div class="space-y-6">
                <div class="prose prose-lg dark:prose-invert">
                    {
                        aboutParagraphs.length > 0 ? (
                            aboutParagraphs.map((paragraph: string) => (
                                <p class="text-gray-600 dark:text-gray-400 leading-relaxed">
                                    {paragraph}
                                </p>
                            ))
                        ) : (
                            <>
                                <p class="text-gray-600 dark:text-gray-400 leading-relaxed">
                                    {t("about.text1")}
                                </p>

                                <p class="text-gray-600 dark:text-gray-400 leading-relaxed">
                                    {t("about.text2")}
                                </p>

                                <p class="text-gray-600 dark:text-gray-400 leading-relaxed">
                                    {t("about.text3")}
                                </p>
                            </>
                        )
                    }
                </div>

                <!-- Languages I Speak -->
                <div
                    class="mt-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800"
                >
                    <h4
                        class="text-lg font-semibold text-gray-900 dark:text-white mb-4 text-center flex items-center justify-center"
                    >
                        <span class="mr-2">üó£Ô∏è</span>
                        {t("about.languagesSpoken")}
                    </h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {
                            languagesSpoken && languagesSpoken.length > 0 ? (
                                languagesSpoken.map((language) => (
                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all duration-200">
                                        <span class="text-2xl mr-3">
                                            {language.flag_emoji}
                                        </span>
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                {language.language_name}
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {t(
                                                    proficiencyMap[
                                                        language.proficiency_level as keyof typeof proficiencyMap
                                                    ],
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <>
                                    {/* Fallback to hardcoded languages */}
                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-300 dark:hover:border-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all duration-200">
                                        <span class="text-2xl mr-3">üáßüá∑</span>
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                Portugu√™s
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {t("about.language.native")}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-red-300 dark:hover:border-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200">
                                        <span class="text-2xl mr-3">üá∫üá∏</span>
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                English
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {t("about.language.fluent")}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-yellow-300 dark:hover:border-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-all duration-200">
                                        <span class="text-2xl mr-3">üá™üá∏</span>
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                Espa√±ol
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {t("about.language.fluent")}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-200">
                                        <span class="text-2xl mr-3">üá®üá¶</span>
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                Fran√ßais
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {t("about.language.advanced")}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-300 dark:hover:border-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all duration-200 opacity-75 relative overflow-hidden">
                                        <span class="text-2xl mr-3">üáÆüáπ</span>
                                        <div>
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                Italiano
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                {t("about.language.beginner")}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )
                        }
                    </div>
                </div>
            </div>

            <!-- Skills Section -->
            <div class="space-y-8">
                <h3
                    class="text-2xl font-semibold text-gray-900 dark:text-white"
                >
                    {t("skills.title")}
                </h3>

                <div class="space-y-8">
                    {
                        skillCategories.map((category) => (
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
                                    <span class="w-2 h-2 bg-primary-600 rounded-full mr-3" />
                                    {category.name}
                                </h4>

                                {/* Direct skills under category */}
                                {category.skills.length > 0 && (
                                    <div class="grid grid-cols-2 gap-3">
                                        {category.skills.map((skill) => (
                                            <div class="group">
                                                <div class="px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all duration-200 cursor-default">
                                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-primary-700 dark:group-hover:text-primary-300 transition-colors">
                                                        {skill}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* Subcategories with their skills */}
                                {category.subcategories.length > 0 && (
                                    <div class="space-y-4 ml-4">
                                        {category.subcategories.map(
                                            (subcategory) => (
                                                <div class="space-y-3">
                                                    <h5 class="text-base font-medium text-gray-700 dark:text-gray-300 flex items-center">
                                                        <span class="text-primary-600 dark:text-primary-400 mr-2">
                                                            üìÅ
                                                        </span>
                                                        {subcategory.name}
                                                    </h5>
                                                    <div class="grid grid-cols-2 gap-3 ml-6">
                                                        {subcategory.skills.map(
                                                            (skill) => (
                                                                <div class="group">
                                                                    <div class="px-3 py-2 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all duration-200 cursor-default">
                                                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-primary-700 dark:group-hover:text-primary-300 transition-colors">
                                                                            {
                                                                                skill
                                                                            }
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            ),
                                                        )}
                                                    </div>
                                                </div>
                                            ),
                                        )}
                                    </div>
                                )}
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</section>
