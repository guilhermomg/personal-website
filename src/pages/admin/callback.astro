---
export const prerender = false;
---

<!doctype html>
<html>
    <head>
        <title>Authenticating...</title>
    </head>
    <body>
        <div
            style="display: flex; align-items: center; justify-content: center; min-height: 100vh; font-family: system-ui, sans-serif;"
        >
            <div style="text-align: center;">
                <div
                    style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"
                >
                </div>
                <p style="color: #666;">Processing authentication...</p>
            </div>
        </div>

        <style>
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>

        <script>
            import { supabase } from "../../lib/supabase";

            async function handleCallback() {
                try {
                    if (window.location.hash) {
                        const hashParams = new URLSearchParams(
                            window.location.hash.substring(1)
                        );
                        const accessToken = hashParams.get("access_token");
                        const refreshToken = hashParams.get("refresh_token");

                        if (accessToken) {
                            const response = await fetch(
                                "/api/auth/set-session",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        access_token: accessToken,
                                        refresh_token: refreshToken || "",
                                    }),
                                }
                            );

                            const result = await response.json();

                            if (!response.ok || result.error) {
                                window.location.href =
                                    "/admin/login?error=session_failed";
                                return;
                            }

                            await supabase.auth.setSession({
                                access_token: accessToken,
                                refresh_token: refreshToken || "",
                            });

                            window.location.href = "/admin/dashboard";
                            return;
                        }
                    }

                    // No tokens found
                    window.location.href = "/admin/login?error=no_tokens";
                } catch (error) {
                    window.location.href = "/admin/login?error=callback_failed";
                }
            }

            // Run on page load
            handleCallback();
        </script>
    </body>
</html>
