---
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import { createServerClient } from "../../../lib/supabase";

const adminEmail = import.meta.env.ADMIN_EMAIL;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

if (user.email !== adminEmail) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

// User is authenticated and authorized
const userEmail = user.email;
---

<Layout title="New Article - Admin - Guilhermo González">
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8 flex items-center gap-4">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ← Back to Dashboard
                </a>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    Create New Article
                </h1>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form id="article-form" class="space-y-6">
                    <!-- Title -->
                    <div>
                        <label
                            for="title"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Title
                        </label>
                        <input
                            type="text"
                            id="title"
                            name="title"
                            required
                            placeholder="Enter article title"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                    </div>

                    <!-- Slug -->
                    <div>
                        <label
                            for="slug"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Slug
                        </label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            required
                            placeholder="article-slug"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                        <p
                            class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                        >
                            Auto-generated from title. Edit manually if needed.
                        </p>
                    </div>

                    <!-- Content -->
                    <div>
                        <label
                            for="content"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Content (Markdown)
                        </label>
                        <textarea
                            id="content"
                            name="content"
                            required
                            rows="12"
                            placeholder="Write your article content in Markdown..."
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                        ></textarea>
                    </div>

                    <!-- Status -->
                    <div>
                        <label
                            for="status"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Status
                        </label>
                        <select
                            id="status"
                            name="status"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                        </select>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-4">
                        <button
                            type="submit"
                            id="save-btn"
                            class="px-6 py-2 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Save Article
                        </button>
                        <a
                            href="/admin/dashboard"
                            class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                        >
                            Cancel
                        </a>
                    </div>

                    <!-- Error message -->
                    <div
                        id="error-message"
                        class="hidden rounded-lg bg-red-50 dark:bg-red-900/30 p-4 text-sm text-red-700 dark:text-red-200"
                    >
                    </div>

                    <!-- Success message -->
                    <div
                        id="success-message"
                        class="hidden rounded-lg bg-green-50 dark:bg-green-900/30 p-4 text-sm text-green-700 dark:text-green-200"
                    >
                        Article created successfully! Redirecting...
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        import { supabase } from "../../../lib/supabase";

        const form = document.getElementById("article-form") as HTMLFormElement;
        const titleInput = document.getElementById("title") as HTMLInputElement;
        const slugInput = document.getElementById("slug") as HTMLInputElement;
        const saveBtn = document.getElementById(
            "save-btn"
        ) as HTMLButtonElement;
        const errorMessage = document.getElementById(
            "error-message"
        ) as HTMLDivElement;
        const successMessage = document.getElementById(
            "success-message"
        ) as HTMLDivElement;

        // Auto-generate slug from title
        function generateSlug(title: string): string {
            return title
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, "")
                .replace(/\s+/g, "-")
                .replace(/-+/g, "-");
        }

        if (titleInput) {
            titleInput.addEventListener("input", () => {
                if (!slugInput?.dataset.customized) {
                    slugInput!.value = generateSlug(titleInput.value);
                }
            });
        }

        // Allow manual slug editing
        if (slugInput) {
            slugInput.addEventListener("input", () => {
                slugInput.dataset.customized = "true";
            });
        }

        // Handle form submission
        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                if (!saveBtn || !form) return;

                saveBtn.disabled = true;
                errorMessage!.classList.add("hidden");
                successMessage!.classList.add("hidden");

                try {
                    const formData = new FormData(form);
                    const title = (formData.get("title") as string)?.trim();
                    const slug = (formData.get("slug") as string)?.trim();
                    const content = (formData.get("content") as string)?.trim();
                    const status = formData.get("status") as string;

                    if (!title || !slug || !content) {
                        throw new Error("All fields are required");
                    }

                    // Check if slug already exists
                    const { data: existing } = await supabase
                        .from("articles")
                        .select("id")
                        .eq("slug", slug)
                        .single();

                    if (existing) {
                        throw new Error(
                            "Slug already exists. Please use a different slug."
                        );
                    }

                    // Insert new article
                    const { data, error } = await supabase
                        .from("articles")
                        .insert([
                            {
                                title,
                                slug,
                                content,
                                status,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString(),
                            },
                        ])
                        .select()
                        .single();

                    if (error) {
                        throw error;
                    }

                    if (successMessage) {
                        successMessage.classList.remove("hidden");
                    }

                    // Redirect to dashboard after 1.5s
                    setTimeout(() => {
                        window.location.href = "/admin/dashboard";
                    }, 1500);
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to create article";
                    if (errorMessage) {
                        errorMessage.textContent = message;
                        errorMessage.classList.remove("hidden");
                    }
                    saveBtn.disabled = false;
                }
            });
        }
    </script>
</Layout>
