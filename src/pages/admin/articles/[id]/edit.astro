---
export const prerender = false;

import Layout from "../../../../layouts/Layout.astro";
import { createServerClient } from "../../../../lib/supabase";

const adminEmail = import.meta.env.ADMIN_EMAIL;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

if (user.email !== adminEmail) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

// Get article ID from URL params
const { id } = Astro.params;
if (!id) {
    return Astro.redirect("/admin/dashboard");
}

// Fetch article
const { data: article, error: fetchError } = await supabase
    .from("articles")
    .select("id,title,slug,content,status,updated_at,created_at")
    .eq("id", id)
    .single();

// Redirect if article not found
if (!article || fetchError) {
    return Astro.redirect("/admin/dashboard");
}

// User is authenticated and authorized
const userEmail = user.email;
---

<Layout title="Edit Article - Admin - Guilhermo González">
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8 flex items-center gap-4">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ← Back to Dashboard
                </a>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    Edit Article
                </h1>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form
                    id="article-form"
                    data-article-id={article.id}
                    class="space-y-6"
                >
                    <!-- Title -->
                    <div>
                        <label
                            for="title"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Title
                        </label>
                        <input
                            type="text"
                            id="title"
                            name="title"
                            required
                            value={article.title ?? ""}
                            placeholder="Enter article title"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                    </div>

                    <!-- Slug -->
                    <div>
                        <label
                            for="slug"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Slug
                        </label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            required
                            value={article.slug ?? ""}
                            placeholder="article-slug"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                        <p
                            class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                        >
                            Change the URL slug for this article.
                        </p>
                    </div>

                    <!-- Content -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label
                                for="content"
                                class="block text-sm font-semibold text-gray-900 dark:text-white"
                            >
                                Content (Markdown)
                            </label>
                            <button
                                type="button"
                                id="toggle-preview"
                                class="text-sm text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-semibold"
                            >
                                Preview
                            </button>
                        </div>
                        <div class="grid gap-4" id="content-container">
                            <textarea
                                id="content"
                                name="content"
                                required
                                rows="12"
                                placeholder="Write your article content in Markdown..."
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                                >{article.content ?? ""}</textarea
                            >
                            <div
                                id="preview"
                                class="hidden w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900 prose prose-indigo dark:prose-invert max-w-none min-h-[300px]"
                            >
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label
                            for="status"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Status
                        </label>
                        <select
                            id="status"
                            name="status"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                            <option
                                value="draft"
                                selected={article.status === "draft"}
                            >
                                Draft
                            </option>
                            <option
                                value="published"
                                selected={article.status === "published"}
                            >
                                Published
                            </option>
                        </select>
                    </div>

                    <!-- Metadata -->
                    <div
                        class="grid grid-cols-2 gap-4 text-xs text-gray-600 dark:text-gray-400"
                    >
                        <div>
                            <p class="font-semibold">Created</p>
                            <p>
                                {
                                    article.created_at
                                        ? new Date(
                                              article.created_at
                                          ).toLocaleString("en-US", {
                                              dateStyle: "medium",
                                              timeStyle: "short",
                                          })
                                        : "Not set"
                                }
                            </p>
                        </div>
                        <div>
                            <p class="font-semibold">Last Updated</p>
                            <p>
                                {
                                    article.updated_at
                                        ? new Date(
                                              article.updated_at
                                          ).toLocaleString("en-US", {
                                              dateStyle: "medium",
                                              timeStyle: "short",
                                          })
                                        : "Not set"
                                }
                            </p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div
                        class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700"
                    >
                        <button
                            type="submit"
                            id="save-btn"
                            class="px-6 py-2 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Save Changes
                        </button>
                        <a
                            href="/admin/dashboard"
                            class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                        >
                            Cancel
                        </a>
                        <button
                            type="button"
                            id="delete-btn"
                            class="px-6 py-2 border border-red-300 dark:border-red-600 text-red-700 dark:text-red-400 font-semibold rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors ml-auto"
                        >
                            Delete Article
                        </button>
                    </div>

                    <!-- Error message -->
                    <div
                        id="error-message"
                        class="hidden rounded-lg bg-red-50 dark:bg-red-900/30 p-4 text-sm text-red-700 dark:text-red-200"
                    >
                    </div>

                    <!-- Success message -->
                    <div
                        id="success-message"
                        class="hidden rounded-lg bg-green-50 dark:bg-green-900/30 p-4 text-sm text-green-700 dark:text-green-200"
                    >
                        Article updated successfully! Redirecting...
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        import { supabase } from "../../../../lib/supabase";
        import { marked } from "marked";

        const form = document.getElementById("article-form") as HTMLFormElement;
        const titleInput = document.getElementById("title") as HTMLInputElement;
        const slugInput = document.getElementById("slug") as HTMLInputElement;
        const contentTextarea = document.getElementById(
            "content"
        ) as HTMLTextAreaElement;
        const saveBtn = document.getElementById(
            "save-btn"
        ) as HTMLButtonElement;
        const deleteBtn = document.getElementById(
            "delete-btn"
        ) as HTMLButtonElement;
        const errorMessage = document.getElementById(
            "error-message"
        ) as HTMLDivElement;
        const successMessage = document.getElementById(
            "success-message"
        ) as HTMLDivElement;
        const togglePreviewBtn = document.getElementById(
            "toggle-preview"
        ) as HTMLButtonElement;
        const previewDiv = document.getElementById("preview") as HTMLDivElement;
        const contentContainer = document.getElementById(
            "content-container"
        ) as HTMLDivElement;

        const articleId = form?.dataset.articleId || "";
        let isPreviewMode = false;

        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true,
        });

        // Toggle preview
        if (
            togglePreviewBtn &&
            contentTextarea &&
            previewDiv &&
            contentContainer
        ) {
            togglePreviewBtn.addEventListener("click", () => {
                isPreviewMode = !isPreviewMode;

                if (isPreviewMode) {
                    // Show preview
                    togglePreviewBtn.textContent = "Edit";
                    contentTextarea.classList.add("hidden");
                    previewDiv.classList.remove("hidden");
                    contentContainer.classList.remove("gap-4");

                    // Render markdown
                    const markdownText = contentTextarea.value;
                    previewDiv.innerHTML = marked.parse(markdownText) as string;
                } else {
                    // Show editor
                    togglePreviewBtn.textContent = "Preview";
                    contentTextarea.classList.remove("hidden");
                    previewDiv.classList.add("hidden");
                }
            });
        }

        // Handle form submission
        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                if (!saveBtn || !form) return;

                saveBtn.disabled = true;
                errorMessage!.classList.add("hidden");
                successMessage!.classList.add("hidden");

                try {
                    const formData = new FormData(form);
                    const title = (formData.get("title") as string)?.trim();
                    const slug = (formData.get("slug") as string)?.trim();
                    const content = contentTextarea.value.trim();
                    const status = formData.get("status") as string;

                    if (!title || !slug || !content) {
                        throw new Error("All fields are required");
                    }

                    // Check if slug already exists (excluding current article)
                    const { data: existing } = await supabase
                        .from("articles")
                        .select("id")
                        .eq("slug", slug)
                        .neq("id", articleId)
                        .single();

                    if (existing) {
                        throw new Error(
                            "Slug already exists. Please use a different slug."
                        );
                    }

                    // Update article
                    const { error } = await supabase
                        .from("articles")
                        .update({
                            title,
                            slug,
                            content,
                            status,
                            updated_at: new Date().toISOString(),
                        })
                        .eq("id", articleId);

                    if (error) {
                        throw error;
                    }

                    if (successMessage) {
                        successMessage.classList.remove("hidden");
                    }

                    // Redirect to dashboard after 1.5s
                    setTimeout(() => {
                        window.location.href = "/admin/dashboard";
                    }, 1500);
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to update article";
                    if (errorMessage) {
                        errorMessage.textContent = message;
                        errorMessage.classList.remove("hidden");
                    }
                    saveBtn.disabled = false;
                }
            });
        }

        // Handle delete
        if (deleteBtn) {
            deleteBtn.addEventListener("click", async () => {
                if (
                    !confirm(
                        "Are you sure you want to delete this article? This cannot be undone."
                    )
                ) {
                    return;
                }

                deleteBtn.disabled = true;
                errorMessage!.classList.add("hidden");

                try {
                    const { error } = await supabase
                        .from("articles")
                        .delete()
                        .eq("id", articleId);

                    if (error) {
                        throw error;
                    }

                    // Redirect to dashboard
                    window.location.href = "/admin/dashboard";
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to delete article";
                    if (errorMessage) {
                        errorMessage.textContent = message;
                        errorMessage.classList.remove("hidden");
                    }
                    deleteBtn.disabled = false;
                }
            });
        }
    </script>
</Layout>
