---
export const prerender = false;

import Layout from "../../../../layouts/Layout.astro";
import { createServerClient } from "../../../../lib/supabase";
import SaveButton from "../../../../components/SaveButton";
import Toast from "../../../../components/Toast";

const adminGithubUsername = import.meta.env.GITHUB_USERNAME;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

// Get GitHub username from user metadata
const userGithubUsername =
    user.user_metadata?.user_name || user.user_metadata?.preferred_username;

if (userGithubUsername !== adminGithubUsername) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

// Get article ID from URL params
const { id } = Astro.params;
if (!id) {
    return Astro.redirect("/admin/dashboard");
}

// Fetch article
const { data: article, error: fetchError } = await supabase
    .from("articles")
    .select(
        "id,title,slug,content,status,description,featured_image,keywords,excerpt,read_time,updated_at,created_at",
    )
    .eq("id", id)
    .single();

// Redirect if article not found
if (!article || fetchError) {
    return Astro.redirect("/admin/dashboard");
}

// User is authenticated and authorized
const userEmail = user.email;

// Fetch siteAuthor from personal_info table
const { data: personalInfo } = await supabase
    .from("personal_info")
    .select("full_name")
    .single();

const siteAuthor = personalInfo?.full_name || "Admin";
---

<Layout title={`Edit Article - Admin - ${siteAuthor}`}>
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ← Back to Dashboard
                </a>
                <h1
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-4"
                >
                    Edit Article
                </h1>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form
                    id="article-form"
                    data-article-id={article.id}
                    class="space-y-6"
                >
                    <!-- Title -->
                    <div>
                        <label
                            for="title"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Title
                        </label>
                        <input
                            type="text"
                            id="title"
                            name="title"
                            required
                            value={article.title ?? ""}
                            placeholder="Enter article title"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                    </div>

                    <!-- Slug -->
                    <div>
                        <label
                            for="slug"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Slug
                        </label>
                        <input
                            type="text"
                            id="slug"
                            name="slug"
                            required
                            value={article.slug ?? ""}
                            placeholder="article-slug"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                        <p
                            class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                        >
                            Change the URL slug for this article.
                        </p>
                    </div>

                    <!-- Content -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label
                                for="content"
                                class="block text-sm font-semibold text-gray-900 dark:text-white"
                            >
                                Content (Markdown)
                            </label>
                            <button
                                type="button"
                                id="toggle-preview"
                                class="text-sm text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-semibold"
                            >
                                Preview
                            </button>
                        </div>
                        <div class="grid gap-4" id="content-container">
                            <textarea
                                id="content"
                                name="content"
                                required
                                rows="12"
                                placeholder="Write your article content in Markdown..."
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                                >{article.content ?? ""}</textarea
                            >
                            <div
                                id="preview"
                                class="hidden w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900 prose prose-indigo dark:prose-invert max-w-none min-h-[300px]"
                            >
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label
                            for="status"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Status
                        </label>
                        <select
                            id="status"
                            name="status"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                            <option
                                value="draft"
                                selected={article.status === "draft"}
                            >
                                Draft
                            </option>
                            <option
                                value="published"
                                selected={article.status === "published"}
                            >
                                Published
                            </option>
                        </select>
                    </div>

                    <!-- SEO Metadata Section (Collapsible) -->
                    <div
                        class="border-t border-gray-200 dark:border-gray-700 pt-6 mt-6"
                    >
                        <button
                            type="button"
                            id="toggle-seo"
                            class="flex items-center justify-between w-full text-left mb-4 hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
                        >
                            <h3
                                class="text-lg font-semibold text-gray-900 dark:text-white"
                            >
                                SEO & Social Metadata
                            </h3>
                            <svg
                                id="seo-chevron"
                                class="w-5 h-5 text-gray-500 dark:text-gray-400 transform transition-transform"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="seo-section" class="hidden space-y-6">
                            <!-- Description -->
                            <div>
                                <label
                                    for="description"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Description (for social media cards)
                                </label>
                                <textarea
                                    id="description"
                                    name="description"
                                    maxlength="160"
                                    rows="2"
                                    placeholder="Brief description for LinkedIn/Twitter cards (max 160 chars)"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    >{article.description ?? ""}</textarea
                                >
                                <div
                                    class="flex justify-between items-center mt-1"
                                >
                                    <p
                                        class="text-xs text-gray-600 dark:text-gray-400"
                                    >
                                        Used in social media previews and search
                                        results
                                    </p>
                                    <span
                                        id="desc-counter"
                                        class="text-xs font-medium text-gray-500 dark:text-gray-400"
                                    >
                                        {(article.description ?? "").length} / 160
                                    </span>
                                </div>
                            </div>

                            <!-- Featured Image -->
                            <div>
                                <label
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Featured Image
                                </label>

                                <!-- File Upload -->
                                <div class="mb-3">
                                    <label
                                        for="featured_image_file"
                                        class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1"
                                    >
                                        Upload New Image
                                    </label>
                                    <input
                                        type="file"
                                        id="featured_image_file"
                                        name="featured_image_file"
                                        accept="image/jpeg,image/png"
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 dark:file:bg-primary-900/40 dark:file:text-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                    <p
                                        class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                                    >
                                        JPG or PNG. Max 1MB. Recommended:
                                        1200×628px
                                    </p>
                                </div>

                                <!-- OR separator -->
                                <div class="flex items-center gap-3 my-3">
                                    <div
                                        class="flex-1 h-px bg-gray-300 dark:bg-gray-600"
                                    >
                                    </div>
                                    <span
                                        class="text-xs text-gray-500 dark:text-gray-400"
                                        >OR</span
                                    >
                                    <div
                                        class="flex-1 h-px bg-gray-300 dark:bg-gray-600"
                                    >
                                    </div>
                                </div>

                                <!-- URL Input -->
                                <div>
                                    <label
                                        for="featured_image"
                                        class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1"
                                    >
                                        Image URL
                                    </label>
                                    <input
                                        type="url"
                                        id="featured_image"
                                        name="featured_image"
                                        value={article.featured_image ?? ""}
                                        placeholder="https://example.com/image.jpg"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                    <p
                                        class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                                    >
                                        Paste an existing image URL (will be
                                        replaced if you upload a file)
                                    </p>
                                </div>

                                <!-- Image Preview -->
                                <div
                                    id="image-preview"
                                    class={article.featured_image
                                        ? "mt-3"
                                        : "mt-3 hidden"}
                                >
                                    <img
                                        id="preview-img"
                                        src={article.featured_image ?? ""}
                                        alt="Preview"
                                        class="w-full max-w-md h-48 object-cover rounded-lg border border-gray-300 dark:border-gray-600"
                                    />
                                </div>
                            </div>

                            <!-- Keywords -->
                            <div>
                                <label
                                    for="keywords"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Keywords
                                </label>
                                <input
                                    type="text"
                                    id="keywords"
                                    name="keywords"
                                    value={article.keywords ?? ""}
                                    placeholder="web development, seo, astro, typescript"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                                <p
                                    class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                                >
                                    Comma-separated keywords for SEO
                                </p>
                            </div>

                            <!-- Excerpt -->
                            <div>
                                <label
                                    for="excerpt"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Excerpt (optional)
                                </label>
                                <textarea
                                    id="excerpt"
                                    name="excerpt"
                                    maxlength="200"
                                    rows="2"
                                    placeholder="Custom excerpt for article listings (defaults to description if empty)"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    >{article.excerpt ?? ""}</textarea
                                >
                                <div
                                    class="flex justify-between items-center mt-1"
                                >
                                    <p
                                        class="text-xs text-gray-600 dark:text-gray-400"
                                    >
                                        Shown on article listing pages
                                    </p>
                                    <span
                                        id="excerpt-counter"
                                        class="text-xs font-medium text-gray-500 dark:text-gray-400"
                                    >
                                        {(article.excerpt ?? "").length} / 200
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div
                        class="grid grid-cols-2 gap-4 text-xs text-gray-600 dark:text-gray-400"
                    >
                        <div>
                            <p class="font-semibold">Created</p>
                            <p>
                                {
                                    article.created_at
                                        ? new Date(
                                              article.created_at,
                                          ).toLocaleString("en-US", {
                                              dateStyle: "medium",
                                              timeStyle: "short",
                                          })
                                        : "Not set"
                                }
                            </p>
                        </div>
                        <div>
                            <p class="font-semibold">Last Updated</p>
                            <p>
                                {
                                    article.updated_at
                                        ? new Date(
                                              article.updated_at,
                                          ).toLocaleString("en-US", {
                                              dateStyle: "medium",
                                              timeStyle: "short",
                                          })
                                        : "Not set"
                                }
                            </p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div
                        class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700"
                    >
                        <SaveButton id="save-btn" client:load>
                            Save Changes
                        </SaveButton>
                        <a
                            id="cancel-btn"
                            href="/admin/dashboard"
                            class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                        >
                            Cancel
                        </a>
                        <button
                            type="button"
                            id="delete-btn"
                            class="px-6 py-2 border border-red-300 dark:border-red-600 text-red-700 dark:text-red-400 font-semibold rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors ml-auto"
                        >
                            Delete Article
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Toast component -->
    <Toast client:load />

    <script>
        import { supabase } from "../../../../lib/supabase";
        import { marked } from "marked";

        const form = document.getElementById("article-form") as HTMLFormElement;
        const titleInput = document.getElementById("title") as HTMLInputElement;
        const slugInput = document.getElementById("slug") as HTMLInputElement;
        const contentTextarea = document.getElementById(
            "content",
        ) as HTMLTextAreaElement;
        const saveBtn = document.getElementById(
            "save-btn",
        ) as HTMLButtonElement;
        const deleteBtn = document.getElementById(
            "delete-btn",
        ) as HTMLButtonElement;
        const cancelBtn = document.getElementById(
            "cancel-btn",
        ) as HTMLAnchorElement;
        const togglePreviewBtn = document.getElementById(
            "toggle-preview",
        ) as HTMLButtonElement;
        const previewDiv = document.getElementById("preview") as HTMLDivElement;
        const contentContainer = document.getElementById(
            "content-container",
        ) as HTMLDivElement;
        const descriptionTextarea = document.getElementById(
            "description",
        ) as HTMLTextAreaElement;
        const descCounter = document.getElementById(
            "desc-counter",
        ) as HTMLSpanElement;
        const excerptTextarea = document.getElementById(
            "excerpt",
        ) as HTMLTextAreaElement;
        const excerptCounter = document.getElementById(
            "excerpt-counter",
        ) as HTMLSpanElement;
        const toggleSeoBtn = document.getElementById(
            "toggle-seo",
        ) as HTMLButtonElement;
        const seoSection = document.getElementById(
            "seo-section",
        ) as HTMLDivElement;
        const seoChevron = document.getElementById(
            "seo-chevron",
        ) as HTMLElement;
        const featuredImageInput = document.getElementById(
            "featured_image",
        ) as HTMLInputElement;
        const featuredImageFileInput = document.getElementById(
            "featured_image_file",
        ) as HTMLInputElement;
        const imagePreview = document.getElementById(
            "image-preview",
        ) as HTMLDivElement;
        const previewImg = document.getElementById(
            "preview-img",
        ) as HTMLImageElement;

        const articleId = form?.dataset.articleId || "";
        let isPreviewMode = false;
        let isSeoExpanded = false;

        // Calculate read time from markdown content (assumes 200 words per minute)
        function calculateReadTime(markdown: string): number {
            const text = markdown.replace(/[#*`_~\[\]()]/g, "").trim();
            const wordCount = text
                .split(/\s+/)
                .filter((word) => word.length > 0).length;
            return Math.max(1, Math.round(wordCount / 200));
        }

        // Character counters
        if (descriptionTextarea && descCounter) {
            descriptionTextarea.addEventListener("input", () => {
                const length = descriptionTextarea.value.length;
                descCounter.textContent = `${length} / 160`;
                if (length > 150) {
                    descCounter.classList.add(
                        "text-amber-600",
                        "dark:text-amber-400",
                    );
                } else {
                    descCounter.classList.remove(
                        "text-amber-600",
                        "dark:text-amber-400",
                    );
                }
            });
        }

        if (excerptTextarea && excerptCounter) {
            excerptTextarea.addEventListener("input", () => {
                const length = excerptTextarea.value.length;
                excerptCounter.textContent = `${length} / 200`;
            });
        }

        // Toggle SEO section
        if (toggleSeoBtn && seoSection && seoChevron) {
            toggleSeoBtn.addEventListener("click", () => {
                isSeoExpanded = !isSeoExpanded;
                if (isSeoExpanded) {
                    seoSection.classList.remove("hidden");
                    seoChevron.classList.add("rotate-180");
                } else {
                    seoSection.classList.add("hidden");
                    seoChevron.classList.remove("rotate-180");
                }
            });
        }

        if (featuredImageInput && imagePreview && previewImg) {
            featuredImageInput.addEventListener("input", () => {
                const url = featuredImageInput.value.trim();
                if (url) {
                    previewImg.src = url;
                    imagePreview.classList.remove("hidden");
                } else {
                    imagePreview.classList.add("hidden");
                }
            });

            previewImg.addEventListener("error", () => {
                imagePreview.classList.add("hidden");
            });
        }

        // Handle file input change to show preview
        if (featuredImageFileInput && imagePreview && previewImg) {
            featuredImageFileInput.addEventListener("change", () => {
                const file = featuredImageFileInput.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target?.result as string;
                        imagePreview.classList.remove("hidden");
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.classList.add("hidden");
                }
            });
        }

        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true,
        });

        // Toggle preview
        if (
            togglePreviewBtn &&
            contentTextarea &&
            previewDiv &&
            contentContainer
        ) {
            togglePreviewBtn.addEventListener("click", () => {
                isPreviewMode = !isPreviewMode;

                if (isPreviewMode) {
                    // Show preview
                    togglePreviewBtn.textContent = "Edit";
                    contentTextarea.classList.add("hidden");
                    previewDiv.classList.remove("hidden");
                    contentContainer.classList.remove("gap-4");

                    // Render markdown
                    const markdownText = contentTextarea.value;
                    previewDiv.innerHTML = marked.parse(markdownText) as string;
                } else {
                    // Show editor
                    togglePreviewBtn.textContent = "Preview";
                    contentTextarea.classList.remove("hidden");
                    previewDiv.classList.add("hidden");
                }
            });
        }

        // Handle form submission
        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                if (!saveBtn || !form) return;

                // Trigger loading state for SaveButton
                window.dispatchEvent(new Event("save-btn-loading-start"));
                
                // Disable cancel and delete buttons during processing
                if (cancelBtn) {
                    cancelBtn.classList.add("pointer-events-none", "opacity-50");
                }
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                    deleteBtn.classList.add("opacity-50");
                }

                try {
                    const formData = new FormData(form);
                    const title = (formData.get("title") as string)?.trim();
                    const slug = (formData.get("slug") as string)?.trim();
                    const content = contentTextarea.value.trim();
                    const status = formData.get("status") as string;
                    const description = (
                        formData.get("description") as string
                    )?.trim();
                    let featured_image =
                        (formData.get("featured_image") as string)?.trim() ||
                        null;
                    const keywords =
                        (formData.get("keywords") as string)?.trim() || null;
                    const excerpt =
                        (formData.get("excerpt") as string)?.trim() || null;
                    const imageFile = featuredImageFileInput.files?.[0];

                    // Calculate read time from content
                    const read_time = calculateReadTime(content);

                    if (!title || !slug || !content || !description) {
                        throw new Error(
                            "Title, slug, content, and description are required",
                        );
                    }

                    // Upload image to Supabase Storage if file is provided
                    if (imageFile) {
                        // Validate file size (1MB max)
                        if (imageFile.size > 1 * 1024 * 1024) {
                            throw new Error("Image file must be less than 1MB");
                        }

                        // Generate unique filename with validated extension
                        const rawFileExt =
                            imageFile.name.split(".").pop() || "";
                        const fileExt = rawFileExt.toLowerCase();

                        // Map common image MIME types to expected extensions
                        const mimeToExt: Record<string, string> = {
                            "image/jpeg": "jpg",
                            "image/jpg": "jpg",
                            "image/png": "png",
                            "image/webp": "webp",
                            "image/gif": "gif",
                        };

                        const expectedExt = mimeToExt[imageFile.type];

                        if (
                            !fileExt ||
                            fileExt === imageFile.name.toLowerCase() ||
                            !expectedExt ||
                            fileExt !== expectedExt
                        ) {
                            throw new Error(
                                "Invalid image file type or extension. Please upload a valid image file.",
                            );
                        }

                        const fileName = `${Date.now()}-${Math.random()
                            .toString(36)
                            .substring(2)}.${fileExt}`;
                        const filePath = `articles/${fileName}`;

                        // Upload to Supabase Storage
                        const { data: uploadData, error: uploadError } =
                            await supabase.storage
                                .from("personal-website")
                                .upload(filePath, imageFile, {
                                    contentType: imageFile.type,
                                    upsert: false,
                                });

                        if (uploadError) {
                            throw new Error(
                                `Image upload failed: ${uploadError.message}`,
                            );
                        }

                        // Get public URL
                        const { data: urlData } = supabase.storage
                            .from("personal-website")
                            .getPublicUrl(filePath);

                        featured_image = urlData.publicUrl;
                    }

                    if (description.length > 160) {
                        throw new Error(
                            "Description must be 160 characters or less",
                        );
                    }

                    // Validate keywords format (optional but must be comma-separated if provided)
                    if (keywords && keywords.trim()) {
                        const keywordList = keywords
                            .split(",")
                            .map((k) => k.trim())
                            .filter((k) => k.length > 0);
                        if (keywordList.length === 0) {
                            throw new Error(
                                "Keywords must be comma-separated values",
                            );
                        }
                    }

                    // Check if slug already exists (excluding current article)
                    const { data: existing } = await supabase
                        .from("articles")
                        .select("id")
                        .eq("slug", slug)
                        .neq("id", articleId)
                        .single();

                    if (existing) {
                        throw new Error(
                            "Slug already exists. Please use a different slug.",
                        );
                    }

                    // Update article
                    const updateData: any = {
                        title,
                        slug,
                        content,
                        status,
                        description,
                        featured_image,
                        keywords,
                        excerpt,
                        read_time,
                    };

                    // Set published_at only if status is being set to published and it wasn't published before
                    if (status === "published") {
                        // Check if article was already published
                        const { data: currentArticle } = await supabase
                            .from("articles")
                            .select("published_at")
                            .eq("id", articleId)
                            .single();

                        // Only set published_at if it's not already set
                        if (!currentArticle?.published_at) {
                            updateData.published_at = new Date().toISOString();
                        }
                    }

                    const { error } = await supabase
                        .from("articles")
                        .update(updateData)
                        .eq("id", articleId);

                    if (error) {
                        throw error;
                    }

                    // Show success toast
                    window.dispatchEvent(
                        new CustomEvent("show-toast", {
                            detail: {
                                message: "Article updated successfully! Redirecting...",
                                type: "success",
                            },
                        }),
                    );

                    // Redirect to dashboard after 1.5s
                    setTimeout(() => {
                        window.location.href = "/admin/dashboard";
                    }, 1500);
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to update article";
                    
                    // Show error toast
                    window.dispatchEvent(
                        new CustomEvent("show-toast", {
                            detail: {
                                message: message,
                                type: "error",
                            },
                        }),
                    );
                    
                    // Stop loading state
                    window.dispatchEvent(new Event("save-btn-loading-end"));
                    
                    // Re-enable cancel and delete buttons
                    if (cancelBtn) {
                        cancelBtn.classList.remove("pointer-events-none", "opacity-50");
                    }
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.classList.remove("opacity-50");
                    }
                }
            });
        }

        // Handle delete
        if (deleteBtn) {
            deleteBtn.addEventListener("click", async () => {
                if (
                    !confirm(
                        "Are you sure you want to delete this article? This cannot be undone.",
                    )
                ) {
                    return;
                }

                deleteBtn.disabled = true;

                try {
                    const { error } = await supabase
                        .from("articles")
                        .delete()
                        .eq("id", articleId);

                    if (error) {
                        throw error;
                    }

                    // Show success toast
                    window.dispatchEvent(
                        new CustomEvent("show-toast", {
                            detail: {
                                message: "Article deleted successfully! Redirecting...",
                                type: "success",
                            },
                        }),
                    );

                    setTimeout(() => {
                        window.location.href = "/admin/dashboard";
                    }, 1500);
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to delete article";
                    
                    // Show error toast
                    window.dispatchEvent(
                        new CustomEvent("show-toast", {
                            detail: {
                                message: message,
                                type: "error",
                            },
                        }),
                    );
                    
                    deleteBtn.disabled = false;
                }
            });
        }
    </script>
</Layout>
