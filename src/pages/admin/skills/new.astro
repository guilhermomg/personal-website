---
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import { createServerClient } from "../../../lib/supabase";

const adminGithubUsername = import.meta.env.GITHUB_USERNAME;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

// Get GitHub username from user metadata
const userGithubUsername =
    user.user_metadata?.user_name || user.user_metadata?.preferred_username;

if (userGithubUsername !== adminGithubUsername) {
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

// Fetch site author and languages
const { data: personalInfo } = await supabase
    .from("personal_info")
    .select("full_name")
    .single();

const siteAuthor = personalInfo?.full_name || "Admin";

const { data: siteLanguages } = await supabase
    .from("site_languages")
    .select("language_code, language_name, is_default")
    .eq("is_active", true)
    .order("is_default", { ascending: false });

// Fetch top-level categories (for parent selection)
const { data: parentCategories } = await supabase
    .from("skill_categories")
    .select("id, name")
    .is("parent_category_id", null)
    .eq("is_active", true)
    .order("sort_order", { ascending: true });

const languagesJson = JSON.stringify(siteLanguages || []);
const parentCategoriesJson = JSON.stringify(parentCategories || []);
---

<Layout title={`New Skill Group - Admin - ${siteAuthor}`}>
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ‚Üê Back to Dashboard
                </a>
                <h1
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-4"
                >
                    New Skill Category
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">
                    Create a new skill category (or sub-category) and add skills
                </p>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form id="bulk-form" class="space-y-8">
                    <!-- Parent Category (Optional) -->
                    <div>
                        <label
                            for="parent-category"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Parent Category <span
                                class="text-gray-500 text-xs font-normal"
                                >(optional - leave blank for top-level)</span
                            >
                        </label>
                        <select
                            id="parent-category"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                        >
                            <option value="">None (Create as top-level)</option>
                        </select>
                    </div>

                    <!-- Category Name Section -->
                    <div>
                        <label
                            for="group-name"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Category Name <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="group-name"
                            placeholder="e.g., Frontend, Backend, DevOps"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                    </div>

                    <div>
                        <label
                            for="group-description"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Description
                        </label>
                        <textarea
                            id="group-description"
                            rows="2"
                            placeholder="Optional description"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        ></textarea>
                    </div>

                    <div>
                        <label
                            for="sort-order"
                            class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                        >
                            Sort Order
                        </label>
                        <input
                            type="number"
                            id="sort-order"
                            min="0"
                            value="0"
                            placeholder="Lower numbers appear first"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                        />
                    </div>

                    <!-- Subcategories Section -->
                    <div
                        class="border-t border-gray-200 dark:border-gray-700 pt-8"
                    >
                        <h2
                            class="text-lg font-bold text-gray-900 dark:text-white mb-2"
                        >
                            Subcategories
                        </h2>
                        <p
                            class="text-sm text-gray-600 dark:text-gray-400 mb-6"
                        >
                            Optional: Add subcategories with their own skills.
                            Each subcategory can have multiple skills.
                        </p>

                        <!-- Add Subcategory Input -->
                        <div class="flex gap-2 mb-6">
                            <input
                                type="text"
                                id="new-subcategory-input"
                                placeholder="Type subcategory name... (e.g., Azure, AWS, Infrastructure)"
                                class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <button
                                type="button"
                                id="add-subcategory-btn"
                                class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg transition-colors"
                            >
                                Add Subcategory
                            </button>
                        </div>

                        <div id="subcategories-list" class="space-y-4">
                            <!-- Subcategory cards will be added here -->
                        </div>
                    </div>

                    <!-- Skills List Section -->
                    <div
                        class="border-t border-gray-200 dark:border-gray-700 pt-8"
                    >
                        <h2
                            class="text-lg font-bold text-gray-900 dark:text-white mb-2"
                        >
                            Skills (Parent Level)
                        </h2>
                        <p
                            class="text-sm text-gray-600 dark:text-gray-400 mb-6"
                        >
                            Optional: Add skills directly to this category (not
                            under subcategories). Use this for skills that don't
                            fit into subcategories.
                        </p>

                        <div id="skills-list" class="space-y-3 mb-6">
                            <!-- Skills will be added here -->
                        </div>

                        <!-- Add Skill Input -->
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="new-skill-input"
                                placeholder="Type skill name... (press Enter or click Add)"
                                class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                            />
                            <button
                                type="button"
                                id="add-skill-btn"
                                class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white font-semibold rounded-lg transition-colors"
                            >
                                Add
                            </button>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div
                        id="form-error"
                        class="hidden rounded-lg bg-red-50 dark:bg-red-900/30 px-4 py-3 text-sm text-red-700 dark:text-red-200"
                    >
                    </div>

                    <!-- Success Message -->
                    <div
                        id="form-success"
                        class="hidden rounded-lg bg-green-50 dark:bg-green-900/30 px-4 py-3 text-sm text-green-700 dark:text-green-200"
                    >
                    </div>

                    <!-- Action Buttons -->
                    <div
                        class="border-t border-gray-200 dark:border-gray-700 pt-8 flex gap-4"
                    >
                        <button
                            type="submit"
                            class="flex-1 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Create Category
                        </button>
                        <a
                            href="/admin/dashboard"
                            class="flex-1 px-6 py-3 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-700 text-gray-900 dark:text-white font-semibold rounded-lg transition-colors text-center"
                        >
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script
        type="module"
        define:vars={{
            languagesJson,
            parentCategoriesJson,
            supabaseUrl: import.meta.env.PUBLIC_SUPABASE_URL,
            supabaseAnonKey: import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
        }}
    >
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        document.addEventListener("DOMContentLoaded", () => {
            const siteLanguages = JSON.parse(languagesJson);
            const parentCategories = JSON.parse(parentCategoriesJson);

            const form = document.getElementById("bulk-form");
            const parentCategorySelect =
                document.getElementById("parent-category");
            const groupNameInput = document.getElementById("group-name");
            const newSkillInput = document.getElementById("new-skill-input");
            const addSkillBtn = document.getElementById("add-skill-btn");
            const skillsList = document.getElementById("skills-list");
            const newSubcategoryInput = document.getElementById(
                "new-subcategory-input",
            );
            const addSubcategoryBtn = document.getElementById(
                "add-subcategory-btn",
            );
            const subcategoriesList =
                document.getElementById("subcategories-list");
            const formError = document.getElementById("form-error");
            const formSuccess = document.getElementById("form-success");

            // Populate parent categories dropdown
            parentCategories.forEach((cat) => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.textContent = cat.name;
                parentCategorySelect.appendChild(option);
            });

            let skills = [];
            let subcategories = []; // Array of {name: string, skills: string[], isExpanded: boolean}

            function renderSkillsList() {
                skillsList.innerHTML = "";
                skills.forEach((skill, index) => {
                    const skillItem = document.createElement("div");
                    skillItem.className =
                        "flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-3 rounded-lg group hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors";
                    skillItem.innerHTML = `
                        <span class="text-gray-900 dark:text-white font-medium">${skill}</span>
                        <button type="button" class="text-red-500 hover:text-red-700 text-sm font-semibold opacity-0 group-hover:opacity-100 transition-opacity remove-skill-btn" data-index="${index}">
                            Remove
                        </button>
                    `;
                    skillsList.appendChild(skillItem);

                    skillItem
                        .querySelector(".remove-skill-btn")
                        .addEventListener("click", (e) => {
                            e.preventDefault();
                            skills.splice(index, 1);
                            renderSkillsList();
                        });
                });
            }

            function renderSubcategoriesList() {
                subcategoriesList.innerHTML = "";

                subcategories.forEach((subcategory, subcatIndex) => {
                    const card = document.createElement("div");
                    card.className =
                        "border border-indigo-200 dark:border-indigo-700 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 overflow-hidden";

                    // Card header
                    const header = document.createElement("div");
                    header.className =
                        "flex items-center justify-between p-4 bg-indigo-100 dark:bg-indigo-900/30 cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-900/40 transition-colors";
                    header.innerHTML = `
                        <div class="flex items-center gap-3 flex-1">
                            <span class="text-lg">üìÅ</span>
                            <span class="font-semibold text-gray-900 dark:text-white">${subcategory.name}</span>
                            <span class="text-sm text-gray-600 dark:text-gray-400">(${subcategory.skills.length} skills)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" class="toggle-btn text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-200 text-xl">
                                ${subcategory.isExpanded ? "‚ñº" : "‚ñ∂"}
                            </button>
                            <button type="button" class="delete-subcat-btn text-red-500 hover:text-red-700 px-3 py-1 text-sm font-semibold rounded">
                                Delete
                            </button>
                        </div>
                    `;

                    card.appendChild(header);

                    // Expandable content
                    if (subcategory.isExpanded) {
                        const content = document.createElement("div");
                        content.className =
                            "p-4 space-y-4 border-t border-indigo-200 dark:border-indigo-700";

                        // Skills list
                        const skillsContainer = document.createElement("div");
                        skillsContainer.className = "space-y-2";

                        if (subcategory.skills.length > 0) {
                            const skillsLabel = document.createElement("p");
                            skillsLabel.className =
                                "text-sm font-medium text-gray-700 dark:text-gray-300 mb-2";
                            skillsLabel.textContent = `Skills in ${subcategory.name}:`;
                            skillsContainer.appendChild(skillsLabel);

                            subcategory.skills.forEach((skill, skillIndex) => {
                                const skillItem = document.createElement("div");
                                skillItem.className =
                                    "flex items-center justify-between bg-white dark:bg-gray-800 p-2 rounded group hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                                skillItem.innerHTML = `
                                    <span class="text-gray-900 dark:text-white text-sm">‚Ä¢ ${skill}</span>
                                    <button type="button" class="remove-skill-btn text-red-500 hover:text-red-700 text-xs opacity-0 group-hover:opacity-100 transition-opacity" data-subcat-index="${subcatIndex}" data-skill-index="${skillIndex}">
                                        Remove
                                    </button>
                                `;
                                skillsContainer.appendChild(skillItem);

                                skillItem
                                    .querySelector(".remove-skill-btn")
                                    .addEventListener("click", (e) => {
                                        e.preventDefault();
                                        subcategories[
                                            subcatIndex
                                        ].skills.splice(skillIndex, 1);
                                        renderSubcategoriesList();
                                    });
                            });
                        }

                        content.appendChild(skillsContainer);

                        // Add skill input
                        const addSkillDiv = document.createElement("div");
                        addSkillDiv.className = "flex gap-2 pt-2";
                        addSkillDiv.innerHTML = `
                            <input
                                type="text"
                                class="subcat-skill-input flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="Add skill to ${subcategory.name}..."
                                data-subcat-index="${subcatIndex}"
                            />
                            <button
                                type="button"
                                class="add-subcat-skill-btn px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold rounded transition-colors"
                                data-subcat-index="${subcatIndex}"
                            >
                                Add Skill
                            </button>
                        `;

                        content.appendChild(addSkillDiv);
                        card.appendChild(content);

                        // Add skill button event
                        const addBtn = addSkillDiv.querySelector(
                            ".add-subcat-skill-btn",
                        );
                        const input = addSkillDiv.querySelector(
                            ".subcat-skill-input",
                        );

                        const addSkillToSubcat = () => {
                            const skillName = input.value.trim();
                            if (!skillName) return;

                            if (
                                subcategories[subcatIndex].skills.includes(
                                    skillName,
                                )
                            ) {
                                formError.textContent =
                                    "This skill is already added to this subcategory";
                                formError.classList.remove("hidden");
                                setTimeout(
                                    () => formError.classList.add("hidden"),
                                    3000,
                                );
                                return;
                            }

                            subcategories[subcatIndex].skills.push(skillName);
                            input.value = "";
                            input.focus();
                            renderSubcategoriesList();
                            formError.classList.add("hidden");
                        };

                        addBtn.addEventListener("click", (e) => {
                            e.preventDefault();
                            addSkillToSubcat();
                        });

                        input.addEventListener("keypress", (e) => {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                addSkillToSubcat();
                            }
                        });
                    }

                    // Toggle expand/collapse
                    header
                        .querySelector(".toggle-btn")
                        .addEventListener("click", (e) => {
                            e.stopPropagation();
                            subcategories[subcatIndex].isExpanded =
                                !subcategories[subcatIndex].isExpanded;
                            renderSubcategoriesList();
                        });

                    // Delete subcategory
                    header
                        .querySelector(".delete-subcat-btn")
                        .addEventListener("click", (e) => {
                            e.stopPropagation();
                            if (
                                confirm(
                                    `Delete "${subcategory.name}" and all its skills?`,
                                )
                            ) {
                                subcategories.splice(subcatIndex, 1);
                                renderSubcategoriesList();
                            }
                        });

                    subcategoriesList.appendChild(card);
                });
            }

            function addSkill() {
                const skillName = newSkillInput.value.trim();
                if (!skillName) return;

                if (skills.includes(skillName)) {
                    formError.textContent = "This skill is already added";
                    formError.classList.remove("hidden");
                    setTimeout(() => formError.classList.add("hidden"), 3000);
                    return;
                }

                skills.push(skillName);
                newSkillInput.value = "";
                newSkillInput.focus();
                renderSkillsList();
                formError.classList.add("hidden");
            }

            function addSubcategory() {
                const subcategoryName = newSubcategoryInput.value.trim();
                if (!subcategoryName) return;

                if (subcategories.some((sc) => sc.name === subcategoryName)) {
                    formError.textContent = "This subcategory is already added";
                    formError.classList.remove("hidden");
                    setTimeout(() => formError.classList.add("hidden"), 3000);
                    return;
                }

                subcategories.push({
                    name: subcategoryName,
                    skills: [],
                    isExpanded: true,
                });
                newSubcategoryInput.value = "";
                newSubcategoryInput.focus();
                renderSubcategoriesList();
                formError.classList.add("hidden");
            }

            addSkillBtn.addEventListener("click", (e) => {
                e.preventDefault();
                addSkill();
            });

            newSkillInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addSkill();
                }
            });

            addSubcategoryBtn.addEventListener("click", (e) => {
                e.preventDefault();
                addSubcategory();
            });

            newSubcategoryInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addSubcategory();
                }
            });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                formError.classList.add("hidden");
                formSuccess.classList.add("hidden");

                try {
                    const groupName = groupNameInput.value.trim();
                    const groupDescription = document
                        .getElementById("group-description")
                        .value.trim();
                    const sortOrder =
                        parseInt(document.getElementById("sort-order").value) ||
                        0;
                    const parentCategoryId = parentCategorySelect.value || null;

                    if (!groupName) {
                        throw new Error("Category name is required");
                    }

                    const siteLanguages = JSON.parse(languagesJson);

                    // Create skill category directly with Supabase
                    const { data: group, error: groupError } = await supabase
                        .from("skill_categories")
                        .insert({
                            name: groupName,
                            description: groupDescription || null,
                            parent_category_id: parentCategoryId,
                            sort_order: sortOrder,
                            is_active: true,
                        })
                        .select()
                        .single();

                    if (groupError) {
                        throw new Error(
                            groupError.message || "Failed to create category",
                        );
                    }

                    const groupId = group.id;
                    let totalSubcategories = 0;
                    let totalSubcategorySkills = 0;

                    // Create subcategories with their skills
                    for (const subcategory of subcategories) {
                        const { data: subcat, error: subcategoryError } =
                            await supabase
                                .from("skill_categories")
                                .insert({
                                    name: subcategory.name,
                                    parent_category_id: groupId,
                                    is_active: true,
                                })
                                .select()
                                .single();

                        if (subcategoryError) {
                            throw new Error(
                                `Failed to create subcategory "${subcategory.name}"`,
                            );
                        }

                        totalSubcategories++;
                        const subcatId = subcat.id;

                        // Create skills for this subcategory
                        for (const skillName of subcategory.skills) {
                            const { data: skill, error: skillError } =
                                await supabase
                                    .from("skills")
                                    .insert({
                                        skill_category_id: subcatId,
                                        is_active: true,
                                    })
                                    .select()
                                    .single();

                            if (skillError) {
                                throw new Error(
                                    `Failed to create skill "${skillName}"`,
                                );
                            }

                            const skillId = skill.id;

                            // Create translations for each language
                            const translations = siteLanguages.map((lang) => ({
                                skill_id: skillId,
                                language_code: lang.language_code,
                                name: skillName,
                                description: "",
                            }));

                            const { error: translationError } = await supabase
                                .from("skill_translations")
                                .insert(translations);

                            if (translationError) {
                                throw new Error(
                                    "Failed to create translations",
                                );
                            }

                            totalSubcategorySkills++;
                        }
                    }

                    // Create all skills with translations
                    for (const skillName of skills) {
                        // Create skill directly with Supabase
                        const { data: skill, error: skillError } =
                            await supabase
                                .from("skills")
                                .insert({
                                    skill_category_id: groupId,
                                    is_active: true,
                                })
                                .select()
                                .single();

                        if (skillError) {
                            throw new Error("Failed to create skill");
                        }

                        const skillId = skill.id;

                        // Create translations for each language
                        const translations = siteLanguages.map((lang) => ({
                            skill_id: skillId,
                            language_code: lang.language_code,
                            name: skillName,
                            description: "",
                        }));

                        const { error: translationError } = await supabase
                            .from("skill_translations")
                            .insert(translations);

                        if (translationError) {
                            throw new Error("Failed to create translations");
                        }
                    }

                    // Build success message
                    let messageParts = [];
                    if (totalSubcategories > 0) {
                        messageParts.push(
                            `${totalSubcategories} subcategory(ies)`,
                        );
                        if (totalSubcategorySkills > 0) {
                            messageParts.push(
                                `${totalSubcategorySkills} skill(s) in subcategories`,
                            );
                        }
                    }
                    if (skills.length > 0) {
                        messageParts.push(
                            `${skills.length} parent-level skill(s)`,
                        );
                    }

                    let message = `‚úì Successfully created "${groupName}"`;
                    if (messageParts.length > 0) {
                        message += ` with ${messageParts.join(", ")}!`;
                    } else {
                        message += "!";
                    }
                    message += " Redirecting...";

                    formSuccess.textContent = message;
                    formSuccess.classList.remove("hidden");

                    setTimeout(() => {
                        window.location.href = "/admin/dashboard";
                    }, 1500);
                } catch (error) {
                    formError.textContent =
                        error instanceof Error
                            ? error.message
                            : "An error occurred";
                    formError.classList.remove("hidden");
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }
            });

            // Focus on input on load
            newSkillInput.focus();
        });
    </script>
</Layout>
