---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { createServerClient } from "../../lib/supabase";

const adminGithubUsername = import.meta.env.GITHUB_USERNAME;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

const userGithubUsername =
    user.user_metadata?.user_name || user.user_metadata?.preferred_username;

if (userGithubUsername !== adminGithubUsername) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

// User is authenticated and authorized
const userEmail = user.email;
type Article = {
    id: string;
    title?: string | null;
    slug?: string | null;
    status?: "draft" | "published" | null;
    updated_at?: string | null;
    created_at?: string | null;
};

type Project = {
    id: string;
    name?: string | null;
    description?: string | null;
    status?: "draft" | "published" | null;
    order?: number | null;
    updated_at?: string | null;
    created_at?: string | null;
};

type Experience = {
    id: string;
    title?: string | null;
    company?: string | null;
    start_month?: number | null;
    start_year?: number | null;
    end_year?: number | null;
    is_published?: boolean | null;
    experience_translations?: ExperienceTranslation[] | null;
    updated_at?: string | null;
    created_at?: string | null;
};

type ExperienceTranslation = {
    language_code?: string | null;
    title?: string | null;
};

type SiteLanguage = {
    id: string;
    language_code?: string | null;
    language_name?: string | null;
    is_active?: boolean | null;
    is_default?: boolean | null;
    updated_at?: string | null;
    created_at?: string | null;
};

const { data: articlesData, error: articlesError } = await supabase
    .from("articles")
    .select("id,title,slug,status,updated_at,created_at")
    .order("updated_at", { ascending: false });

const articles = (articlesData ?? []) as Article[];

const { data: projectsData, error: projectsError } = await supabase
    .from("projects")
    .select("id,name,description,status,order,updated_at,created_at")
    .order("order", { ascending: true });

const projects = (projectsData ?? []) as Project[];

const { data: siteLanguagesData, error: siteLanguagesError } = await supabase
    .from("site_languages")
    .select(
        "id, language_code, language_name, is_active, is_default, updated_at, created_at",
    )
    .order("language_code", { ascending: true });

const siteLanguages = (siteLanguagesData ?? []) as SiteLanguage[];

const defaultLanguageCode =
    siteLanguages.find((lang) => lang.is_default)?.language_code ??
    siteLanguages.find((lang) => lang.is_active)?.language_code ??
    null;

const { data: experiencesData, error: experiencesError } = await supabase
    .from("experiences")
    .select(
        "id,company,start_month,start_year,end_year,is_published,updated_at,created_at,experience_translations(language_code,title)",
    )
    .order("start_year", { ascending: false });

const experiences = (experiencesData ?? []).map((experience) => {
    const translations = experience.experience_translations ?? [];
    const defaultTranslation = defaultLanguageCode
        ? translations.find(
              (translation) =>
                  translation.language_code === defaultLanguageCode,
          )
        : undefined;
    const fallbackTranslation = translations[0];

    return {
        ...experience,
        title: defaultTranslation?.title ?? fallbackTranslation?.title ?? null,
    } as Experience;
});

const { data: personalInfo } = await supabase
    .from("personal_info")
    .select("full_name")
    .single();

const formatDate = (value?: string | null) => {
    if (!value) return "Not set";
    const date = new Date(value);
    return Number.isNaN(date.valueOf())
        ? "Not set"
        : date.toLocaleString("en-US", {
              dateStyle: "medium",
              timeStyle: "short",
          });
};
const statusColors = {
    draft: "bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200",
    published:
        "bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200",
};
const siteAuthor = personalInfo?.full_name || "Admin";
---

<Layout title={`Admin Dashboard - ${siteAuthor}`}>
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div id="dashboard">
                <div class="mb-8 flex justify-between items-center">
                    <div>
                        <h1
                            class="text-3xl font-bold text-gray-900 dark:text-white"
                        >
                            Admin Dashboard
                        </h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">
                            Welcome back, {userEmail}
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button
                            id="logout-btn"
                            class="px-6 py-2 border border-transparent text-sm font-semibold rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors h-10 flex items-center"
                        >
                            Sign Out
                        </button>
                    </div>
                </div>

                <div class="grid gap-6">
                    <!-- Personal Info Section -->
                    <div
                        class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6"
                    >
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3
                                    class="text-lg font-semibold text-gray-900 dark:text-white"
                                >
                                    Personal Information
                                </h3>
                                <p
                                    class="text-sm text-gray-600 dark:text-gray-400"
                                >
                                    Manage your profile, about section, and
                                    languages
                                </p>
                            </div>
                            <a
                                href="/admin/personal-info/edit"
                                class="px-4 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700 transition-colors shadow"
                            >
                                Edit Personal Info
                            </a>
                        </div>
                    </div>

                    <!-- Site Languages Section -->
                    <div
                        class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6"
                    >
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3
                                    class="text-lg font-semibold text-gray-900 dark:text-white"
                                >
                                    Site Languages
                                </h3>
                                <p
                                    class="text-sm text-gray-600 dark:text-gray-400"
                                >
                                    Manage active languages and locale settings
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span
                                    class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/40 dark:text-primary-200"
                                >
                                    {siteLanguages.length} total
                                </span>
                                <button
                                    type="button"
                                    id="open-language-modal-btn"
                                    class="px-4 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700 transition-colors shadow"
                                >
                                    + New Language
                                </button>
                            </div>
                        </div>

                        {
                            siteLanguagesError && (
                                <div class="mb-4 rounded-md bg-red-50 dark:bg-red-900/30 p-4 text-sm text-red-700 dark:text-red-200">
                                    Failed to load languages:{" "}
                                    {siteLanguagesError.message}
                                </div>
                            )
                        }

                        {
                            !siteLanguagesError &&
                            siteLanguages.length === 0 ? (
                                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg p-10 text-center">
                                    <p class="text-gray-700 dark:text-gray-200 font-semibold mb-2">
                                        No languages yet
                                    </p>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                                        Add and activate languages for your
                                        site.
                                    </p>
                                    <button
                                        type="button"
                                        id="open-language-modal-empty-btn"
                                        class="px-4 py-2 bg-primary-600 text-white rounded-md text-sm font-semibold hover:bg-primary-700 transition-colors"
                                    >
                                        Add Language
                                    </button>
                                </div>
                            ) : (
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                                            <tr>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Code
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Name
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Status
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Default
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Updated
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            {siteLanguages.map((lang) => (
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/60 transition-colors">
                                                    <td class="px-4 py-4 whitespace-nowrap">
                                                        <div class="text-sm font-semibold text-gray-900 dark:text-white">
                                                            {lang.language_code ??
                                                                "-"}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap">
                                                        <div class="text-sm text-gray-700 dark:text-gray-200">
                                                            {lang.language_name ??
                                                                "-"}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap">
                                                        <span
                                                            class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                                                                lang.is_active
                                                                    ? "bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200"
                                                                    : "bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200"
                                                            }`}
                                                        >
                                                            {lang.is_active
                                                                ? "Active"
                                                                : "Inactive"}
                                                        </span>
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap">
                                                        {lang.is_default && (
                                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200">
                                                                ‚≠ê Default
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-200">
                                                        {formatDate(
                                                            lang.updated_at ??
                                                                lang.created_at,
                                                        )}
                                                    </td>
                                                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <div class="flex justify-end gap-2">
                                                            <button
                                                                type="button"
                                                                class="edit-language-btn px-3 py-1 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors text-xs"
                                                                data-language-id={
                                                                    lang.id
                                                                }
                                                                data-language-code={
                                                                    lang.language_code
                                                                }
                                                                data-language-name={
                                                                    lang.language_name
                                                                }
                                                                data-language-active={
                                                                    lang.is_active
                                                                }
                                                                data-language-default={
                                                                    lang.is_default
                                                                }
                                                            >
                                                                Edit
                                                            </button>
                                                            {!lang.is_default && (
                                                                <button
                                                                    type="button"
                                                                    class="set-default-btn px-3 py-1 rounded-md border border-blue-300 dark:border-blue-600 text-blue-700 dark:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors text-xs"
                                                                    data-language-id={
                                                                        lang.id
                                                                    }
                                                                    data-language-code={
                                                                        lang.language_code
                                                                    }
                                                                >
                                                                    Set Default
                                                                </button>
                                                            )}
                                                            <button
                                                                type="button"
                                                                class="toggle-language-btn px-3 py-1 rounded-md text-xs transition-colors"
                                                                class:list={[
                                                                    lang.is_active
                                                                        ? "border border-amber-300 dark:border-amber-600 text-amber-700 dark:text-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20"
                                                                        : "border border-green-300 dark:border-green-600 text-green-700 dark:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/20",
                                                                ]}
                                                                data-language-id={
                                                                    lang.id
                                                                }
                                                                data-language-code={
                                                                    lang.language_code
                                                                }
                                                                data-language-active={
                                                                    lang.is_active
                                                                }
                                                            >
                                                                {lang.is_active
                                                                    ? "Deactivate"
                                                                    : "Activate"}
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )
                        }
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6"
                    >
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3
                                    class="text-lg font-semibold text-gray-900 dark:text-white"
                                >
                                    Articles
                                </h3>
                                <p
                                    class="text-sm text-gray-600 dark:text-gray-400"
                                >
                                    Manage and edit your published and draft
                                    articles
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span
                                    class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/40 dark:text-primary-200"
                                >
                                    {articles.length} total
                                </span>
                                <a
                                    href="/admin/articles/new"
                                    class="px-4 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700 transition-colors shadow"
                                >
                                    + New Article
                                </a>
                            </div>
                        </div>

                        {
                            articlesError && (
                                <div class="mb-4 rounded-md bg-red-50 dark:bg-red-900/30 p-4 text-sm text-red-700 dark:text-red-200">
                                    Failed to load articles:{" "}
                                    {articlesError.message}
                                </div>
                            )
                        }

                        {
                            !articlesError && articles.length === 0 ? (
                                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg p-10 text-center">
                                    <p class="text-gray-700 dark:text-gray-200 font-semibold mb-2">
                                        No articles yet
                                    </p>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                                        Create your first article to see it
                                        listed here.
                                    </p>
                                    <a
                                        href="/admin/articles/new"
                                        class="px-4 py-2 bg-primary-600 text-white rounded-md text-sm font-semibold hover:bg-primary-700 transition-colors"
                                    >
                                        Create article
                                    </a>
                                </div>
                            ) : (
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                                            <tr>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Title
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Status
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Last Updated
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            {articles.map((article) => {
                                                const status:
                                                    | "draft"
                                                    | "published" =
                                                    article.status ?? "draft";
                                                const viewHref =
                                                    status === "published" &&
                                                    article.slug
                                                        ? `/articles/${article.slug}`
                                                        : `/admin/articles/${article.id}/preview`;

                                                return (
                                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/60 transition-colors">
                                                        <td class="px-4 py-4 whitespace-nowrap">
                                                            <div class="text-sm font-semibold text-gray-900 dark:text-white">
                                                                {article.title ??
                                                                    "Untitled"}
                                                            </div>
                                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                                {article.slug
                                                                    ? `/articles/${article.slug}`
                                                                    : `ID: ${article.id}`}
                                                            </div>
                                                        </td>
                                                        <td class="px-4 py-4 whitespace-nowrap">
                                                            <span
                                                                class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusColors[status] ?? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"}`}
                                                            >
                                                                {status}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-200">
                                                            {formatDate(
                                                                article.updated_at ??
                                                                    article.created_at,
                                                            )}
                                                        </td>
                                                        <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                            <div class="flex justify-end gap-2">
                                                                <a
                                                                    href={
                                                                        viewHref
                                                                    }
                                                                    class="px-3 py-1 rounded-md border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-xs"
                                                                >
                                                                    View
                                                                </a>
                                                                <a
                                                                    href={`/admin/articles/${article.id}/edit`}
                                                                    class="px-3 py-1 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors text-xs"
                                                                >
                                                                    Edit
                                                                </a>
                                                                <button
                                                                    type="button"
                                                                    data-article-id={
                                                                        article.id
                                                                    }
                                                                    class="delete-article-btn px-3 py-1 rounded-md border border-red-300 dark:border-red-600 text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-xs"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )
                        }
                    </div>

                    <!-- Projects Section -->
                    <div
                        class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6"
                    >
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3
                                    class="text-lg font-semibold text-gray-900 dark:text-white"
                                >
                                    Projects
                                </h3>
                                <p
                                    class="text-sm text-gray-600 dark:text-gray-400"
                                >
                                    Manage your portfolio projects
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span
                                    class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/40 dark:text-primary-200"
                                >
                                    {projects.length} total
                                </span>
                                <a
                                    href="/admin/projects/new"
                                    class="px-4 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700 transition-colors shadow"
                                >
                                    + New Project
                                </a>
                            </div>
                        </div>

                        {
                            projectsError && (
                                <div class="mb-4 rounded-md bg-red-50 dark:bg-red-900/30 p-4 text-sm text-red-700 dark:text-red-200">
                                    Failed to load projects:{" "}
                                    {projectsError.message}
                                </div>
                            )
                        }

                        {
                            !projectsError && projects.length === 0 ? (
                                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg p-10 text-center">
                                    <p class="text-gray-700 dark:text-gray-200 font-semibold mb-2">
                                        No projects yet
                                    </p>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                                        Create your first project to showcase
                                        your work.
                                    </p>
                                    <a
                                        href="/admin/projects/new"
                                        class="px-4 py-2 bg-primary-600 text-white rounded-md text-sm font-semibold hover:bg-primary-700 transition-colors"
                                    >
                                        Create project
                                    </a>
                                </div>
                            ) : (
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                                            <tr>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Name
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Description
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Status
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Order
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            {projects.map((project) => {
                                                const status:
                                                    | "draft"
                                                    | "published" =
                                                    project.status ?? "draft";

                                                return (
                                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/60 transition-colors">
                                                        <td class="px-4 py-4">
                                                            <div class="text-sm font-semibold text-gray-900 dark:text-white">
                                                                {project.name ??
                                                                    "Untitled"}
                                                            </div>
                                                        </td>
                                                        <td class="px-4 py-4">
                                                            <div class="text-sm text-gray-700 dark:text-gray-200 max-w-md truncate">
                                                                {project.description ??
                                                                    "No description"}
                                                            </div>
                                                        </td>
                                                        <td class="px-4 py-4 whitespace-nowrap">
                                                            <span
                                                                class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusColors[status] ?? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"}`}
                                                            >
                                                                {status}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-200">
                                                            {project.order ?? 0}
                                                        </td>
                                                        <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                            <div class="flex justify-end gap-2">
                                                                <a
                                                                    href={`/admin/projects/${project.id}/edit`}
                                                                    class="px-3 py-1 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors text-xs"
                                                                >
                                                                    Edit
                                                                </a>
                                                                <button
                                                                    type="button"
                                                                    data-project-id={
                                                                        project.id
                                                                    }
                                                                    class="delete-project-btn px-3 py-1 rounded-md border border-red-300 dark:border-red-600 text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-xs"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )
                        }
                    </div>

                    <!-- Experiences Section -->
                    <div
                        class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6"
                    >
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3
                                    class="text-lg font-semibold text-gray-900 dark:text-white"
                                >
                                    Experiences
                                </h3>
                                <p
                                    class="text-sm text-gray-600 dark:text-gray-400"
                                >
                                    Manage your work experience and career
                                    history
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span
                                    class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/40 dark:text-primary-200"
                                >
                                    {experiences.length} total
                                </span>
                                <a
                                    href="/admin/experiences/new"
                                    class="px-4 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700 transition-colors shadow"
                                >
                                    + New Experience
                                </a>
                            </div>
                        </div>

                        {
                            experiencesError && (
                                <div class="mb-4 rounded-md bg-red-50 dark:bg-red-900/30 p-4 text-sm text-red-700 dark:text-red-200">
                                    Failed to load experiences:{" "}
                                    {experiencesError.message}
                                </div>
                            )
                        }

                        {
                            !experiencesError && experiences.length === 0 ? (
                                <div class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg p-10 text-center">
                                    <p class="text-gray-700 dark:text-gray-200 font-semibold mb-2">
                                        No experiences yet
                                    </p>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                                        Create your first experience to showcase
                                        your career.
                                    </p>
                                    <a
                                        href="/admin/experiences/new"
                                        class="px-4 py-2 bg-primary-600 text-white rounded-md text-sm font-semibold hover:bg-primary-700 transition-colors"
                                    >
                                        Create experience
                                    </a>
                                </div>
                            ) : (
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                                            <tr>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Title
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Company
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Period
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Status
                                                </th>
                                                <th
                                                    scope="col"
                                                    class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider"
                                                >
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            {experiences.map(
                                                (exp: Experience) => {
                                                    const startDate =
                                                        exp.start_month &&
                                                        exp.start_year
                                                            ? `${exp.start_month}/${exp.start_year}`
                                                            : "N/A";
                                                    const endDate = exp.end_year
                                                        ? `${exp.end_year}`
                                                        : "Present";

                                                    return (
                                                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/60 transition-colors">
                                                            <td class="px-4 py-4 whitespace-nowrap">
                                                                <div class="text-sm font-semibold text-gray-900 dark:text-white">
                                                                    {exp.title ??
                                                                        "Untitled"}
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-4 whitespace-nowrap">
                                                                <div class="text-sm text-gray-700 dark:text-gray-200">
                                                                    {
                                                                        exp.company
                                                                    }
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-4 whitespace-nowrap">
                                                                <div class="text-sm text-gray-700 dark:text-gray-200">
                                                                    {startDate}{" "}
                                                                    - {endDate}
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-4 whitespace-nowrap">
                                                                <span
                                                                    class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                                                                        exp.is_published
                                                                            ? "bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200"
                                                                            : "bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200"
                                                                    }`}
                                                                >
                                                                    {exp.is_published
                                                                        ? "Published"
                                                                        : "Draft"}
                                                                </span>
                                                            </td>
                                                            <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                <div class="flex justify-end gap-2">
                                                                    <a
                                                                        href={`/admin/experiences/${exp.id}/edit`}
                                                                        class="px-3 py-1 rounded-md bg-primary-600 text-white hover:bg-primary-700 transition-colors text-xs"
                                                                    >
                                                                        Edit
                                                                    </a>
                                                                    <button
                                                                        type="button"
                                                                        data-experience-id={
                                                                            exp.id
                                                                        }
                                                                        class="delete-experience-btn px-3 py-1 rounded-md border border-red-300 dark:border-red-600 text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-xs"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                },
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Modal -->
    <div
        id="language-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
        <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full mx-4"
        >
            <div class="flex justify-between items-center mb-6">
                <h3
                    id="language-modal-title"
                    class="text-xl font-semibold text-gray-900 dark:text-white"
                >
                    Add Language
                </h3>
                <button
                    id="close-language-modal-btn"
                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="language-form" class="space-y-4">
                <input type="hidden" id="language-id" />

                <div>
                    <label
                        for="language-code"
                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                    >
                        Language Code *
                    </label>
                    <input
                        type="text"
                        id="language-code"
                        placeholder="e.g., es"
                        required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    />
                </div>

                <div>
                    <label
                        for="language-name"
                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                    >
                        Language Name *
                    </label>
                    <input
                        type="text"
                        id="language-name"
                        placeholder="e.g., Espa√±ol"
                        required
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    />
                </div>

                <div id="language-active-toggle-container" class="hidden pt-2">
                    <label
                        class="flex items-center gap-3 text-sm text-gray-700 dark:text-gray-300 cursor-pointer"
                    >
                        <input
                            type="checkbox"
                            id="language-active"
                            class="h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                        />
                        <span class="font-medium">Active</span>
                    </label>
                </div>

                <div id="language-default-toggle-container" class="hidden pt-2">
                    <label
                        class="flex items-center gap-3 text-sm text-gray-700 dark:text-gray-300 cursor-pointer"
                    >
                        <input
                            type="checkbox"
                            id="language-default"
                            class="h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                        />
                        <span class="font-medium">‚≠ê Set as Default</span>
                    </label>
                    <p
                        class="text-xs text-gray-500 dark:text-gray-400 mt-1 ml-8"
                    >
                        Only one language can be default. Setting this will
                        unset the current default.
                    </p>
                </div>

                <div
                    id="language-form-error"
                    class="hidden rounded-lg bg-red-50 dark:bg-red-900/30 px-4 py-2 text-sm text-red-700 dark:text-red-200"
                >
                </div>

                <div class="flex gap-3 pt-4">
                    <button
                        type="button"
                        id="cancel-language-btn"
                        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        id="save-language-btn"
                        class="flex-1 px-4 py-2 rounded-md bg-primary-600 text-white font-semibold hover:bg-primary-700 transition-colors"
                    >
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        import { supabase } from "../../lib/supabase";

        const logoutBtn = document.getElementById("logout-btn");

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = "/admin/login";
        }

        if (logoutBtn) {
            logoutBtn.addEventListener("click", logout);
        }

        // Handle delete buttons
        const deleteButtons = document.querySelectorAll(".delete-article-btn");
        deleteButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const articleId = (e.target as HTMLButtonElement).dataset
                    .articleId;

                if (
                    !confirm(
                        "Are you sure you want to delete this article? This cannot be undone.",
                    )
                ) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from("articles")
                        .delete()
                        .eq("id", articleId);

                    if (error) {
                        throw error;
                    }

                    // Reload the page to refresh the list
                    window.location.reload();
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to delete article";
                    alert(message);
                }
            });
        });

        // Handle delete project buttons
        const deleteProjectButtons = document.querySelectorAll(
            ".delete-project-btn",
        );
        deleteProjectButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const projectId = (e.target as HTMLButtonElement).dataset
                    .projectId;

                if (
                    !confirm(
                        "Are you sure you want to delete this project? This cannot be undone.",
                    )
                ) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from("projects")
                        .delete()
                        .eq("id", projectId);

                    if (error) {
                        throw error;
                    }

                    // Reload the page to refresh the list
                    window.location.reload();
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to delete project";
                    alert(message);
                }
            });
        });

        // Handle delete experience buttons
        const deleteExperienceButtons = document.querySelectorAll(
            ".delete-experience-btn",
        );
        deleteExperienceButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const experienceId = (e.target as HTMLButtonElement).dataset
                    .experienceId;

                if (
                    !confirm(
                        "Are you sure you want to delete this experience? This cannot be undone.",
                    )
                ) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from("experiences")
                        .delete()
                        .eq("id", experienceId);

                    if (error) {
                        throw error;
                    }

                    // Reload the page to refresh the list
                    window.location.reload();
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to delete experience";
                    alert(message);
                }
            });
        });

        // Handle toggle language buttons
        const toggleLanguageButtons = document.querySelectorAll(
            ".toggle-language-btn",
        );
        toggleLanguageButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const target = e.target as HTMLButtonElement;
                const languageId = target.dataset.languageId;
                const languageCode = target.dataset.languageCode;
                const isActive = target.dataset.languageActive === "true";

                const action = isActive ? "deactivate" : "activate";
                const message = `Are you sure you want to ${action} the language "${languageCode}"?`;

                if (!confirm(message)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from("site_languages")
                        .update({
                            is_active: !isActive,
                            updated_at: new Date().toISOString(),
                        })
                        .eq("id", languageId);

                    if (error) {
                        throw error;
                    }

                    // Reload the page to refresh the list
                    window.location.reload();
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to update language";
                    alert(message);
                }
            });
        });

        // Language Modal Handling
        const languageModal = document.getElementById("language-modal");
        const languageModalTitle = document.getElementById(
            "language-modal-title",
        );
        const languageForm = document.getElementById(
            "language-form",
        ) as HTMLFormElement;
        const languageFormError = document.getElementById(
            "language-form-error",
        );
        const languageIdInput = document.getElementById(
            "language-id",
        ) as HTMLInputElement;
        const languageCodeInput = document.getElementById(
            "language-code",
        ) as HTMLInputElement;
        const languageNameInput = document.getElementById(
            "language-name",
        ) as HTMLInputElement;
        const languageActiveInput = document.getElementById(
            "language-active",
        ) as HTMLInputElement;
        const languageDefaultInput = document.getElementById(
            "language-default",
        ) as HTMLInputElement;
        const languageActiveToggleContainer = document.getElementById(
            "language-active-toggle-container",
        );
        const languageDefaultToggleContainer = document.getElementById(
            "language-default-toggle-container",
        );

        const openLanguageModalBtn = document.getElementById(
            "open-language-modal-btn",
        );
        const openLanguageModalEmptyBtn = document.getElementById(
            "open-language-modal-empty-btn",
        );
        const closeLanguageModalBtn = document.getElementById(
            "close-language-modal-btn",
        );
        const cancelLanguageBtn = document.getElementById(
            "cancel-language-btn",
        );

        const existingLanguageCodes = new Set(
            Array.from(document.querySelectorAll(".edit-language-btn")).map(
                (btn) =>
                    (
                        btn as HTMLButtonElement
                    ).dataset.languageCode?.toLowerCase(),
            ),
        );

        function openLanguageModal(isEdit = false) {
            if (!languageModal) return;

            languageModal.classList.remove("hidden");
            if (languageModalTitle) {
                languageModalTitle.textContent = isEdit
                    ? "Edit Language"
                    : "Add Language";
            }

            if (languageActiveToggleContainer) {
                if (isEdit) {
                    languageActiveToggleContainer.classList.remove("hidden");
                } else {
                    languageActiveToggleContainer.classList.add("hidden");
                    languageActiveInput.checked = true;
                }
            }

            if (languageDefaultToggleContainer) {
                if (isEdit) {
                    languageDefaultToggleContainer.classList.remove("hidden");
                } else {
                    languageDefaultToggleContainer.classList.add("hidden");
                    languageDefaultInput.checked = false;
                }
            }

            hideLanguageError();
        }

        function closeLanguageModal() {
            if (!languageModal || !languageForm) return;
            languageModal.classList.add("hidden");
            languageForm.reset();
            languageIdInput.value = "";
            hideLanguageError();
        }

        function showLanguageError(message: string) {
            if (!languageFormError) return;
            languageFormError.textContent = message;
            languageFormError.classList.remove("hidden");
        }

        function hideLanguageError() {
            if (!languageFormError) return;
            languageFormError.classList.add("hidden");
        }

        openLanguageModalBtn?.addEventListener("click", () =>
            openLanguageModal(false),
        );
        openLanguageModalEmptyBtn?.addEventListener("click", () =>
            openLanguageModal(false),
        );
        closeLanguageModalBtn?.addEventListener("click", closeLanguageModal);
        cancelLanguageBtn?.addEventListener("click", closeLanguageModal);

        languageModal?.addEventListener("click", (e) => {
            if (e.target === languageModal) closeLanguageModal();
        });

        document.querySelectorAll(".edit-language-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                const target = btn as HTMLButtonElement;
                languageIdInput.value = target.dataset.languageId || "";
                languageCodeInput.value = target.dataset.languageCode || "";
                languageNameInput.value = target.dataset.languageName || "";
                languageActiveInput.checked =
                    target.dataset.languageActive === "true";
                languageDefaultInput.checked =
                    target.dataset.languageDefault === "true";
                openLanguageModal(true);
            });
        });

        languageForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            hideLanguageError();

            const id = languageIdInput.value.trim();
            const code = languageCodeInput.value.trim().toLowerCase();
            const name = languageNameInput.value.trim();
            const isActive = languageActiveInput.checked;
            const isDefault = languageDefaultInput.checked;

            if (!code || !name) {
                return showLanguageError("Code and name are required");
            }

            // Check for duplicate code
            if (id) {
                // Edit mode - check if code changed and conflicts
                const originalCode = (
                    document.querySelector(
                        `.edit-language-btn[data-language-id="${id}"]`,
                    ) as HTMLButtonElement
                )?.dataset.languageCode?.toLowerCase();

                if (code !== originalCode && existingLanguageCodes.has(code)) {
                    return showLanguageError(
                        `Language code already exists: ${code}`,
                    );
                }
            } else {
                // Add mode - check if code exists
                if (existingLanguageCodes.has(code)) {
                    return showLanguageError(
                        `Language code already exists: ${code}`,
                    );
                }
            }

            try {
                // If setting as default, first unset all other defaults
                if (isDefault) {
                    const { error: unsetError } = await supabase
                        .from("site_languages")
                        .update({ is_default: false })
                        .neq("id", id || "");

                    if (unsetError) throw unsetError;
                }

                if (id) {
                    // Update existing
                    const { error } = await supabase
                        .from("site_languages")
                        .update({
                            language_code: code,
                            language_name: name,
                            is_active: isActive,
                            is_default: isDefault,
                            updated_at: new Date().toISOString(),
                        })
                        .eq("id", id);

                    if (error) throw error;
                } else {
                    // Insert new
                    const { error } = await supabase
                        .from("site_languages")
                        .insert({
                            language_code: code,
                            language_name: name,
                            is_active: isActive,
                            is_default: isDefault,
                        });

                    if (error) throw error;
                }

                window.location.reload();
            } catch (err) {
                showLanguageError(
                    err instanceof Error
                        ? err.message
                        : "Failed to save language",
                );
            }
        });

        // Handle set as default buttons
        const setDefaultButtons = document.querySelectorAll(".set-default-btn");
        setDefaultButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const target = e.target as HTMLButtonElement;
                const languageId = target.dataset.languageId;
                const languageCode = target.dataset.languageCode;

                const message = `Are you sure you want to set "${languageCode}" as the default language?`;

                if (!confirm(message)) {
                    return;
                }

                try {
                    // First unset all other defaults
                    const { error: unsetError } = await supabase
                        .from("site_languages")
                        .update({ is_default: false })
                        .neq("id", languageId);

                    if (unsetError) throw unsetError;

                    // Then set this one as default
                    const { error } = await supabase
                        .from("site_languages")
                        .update({
                            is_default: true,
                            updated_at: new Date().toISOString(),
                        })
                        .eq("id", languageId);

                    if (error) throw error;

                    // Reload the page to refresh the list
                    window.location.reload();
                } catch (err) {
                    const message =
                        err instanceof Error
                            ? err.message
                            : "Failed to set default language";
                    alert(message);
                }
            });
        });
    </script>
</Layout>
