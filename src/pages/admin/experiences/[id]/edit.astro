---
export const prerender = false;

import Layout from "../../../../layouts/Layout.astro";
import { createServerClient } from "../../../../lib/supabase";

const adminGithubUsername = import.meta.env.GITHUB_USERNAME;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

// Get GitHub username from user metadata
const userGithubUsername =
    user.user_metadata?.user_name || user.user_metadata?.preferred_username;

if (userGithubUsername !== adminGithubUsername) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

const { data: siteLanguages } = await supabase
    .from("site_languages")
    .select("language_code, language_name, is_default, is_active")
    .eq("is_active", true)
    .order("language_code", { ascending: true });

const activeLanguages = (siteLanguages ?? []) as {
    language_code?: string | null;
    language_name?: string | null;
    is_default?: boolean | null;
}[];

const defaultLanguage =
    activeLanguages.find((lang) => lang.is_default) ?? activeLanguages[0];
const defaultLanguageCode = defaultLanguage?.language_code ?? "";
const defaultLanguageName = defaultLanguage?.language_name ?? "Default";

// Get experience ID from URL params
const { id } = Astro.params;
if (!id) {
    return Astro.redirect("/admin/dashboard");
}

// Fetch experience with translations
const { data: experience, error: fetchError } = await supabase
    .from("experiences")
    .select(
        `
        id,
        company,
        start_month,
        start_year,
        end_month,
        end_year,
        is_published,
        created_at,
        updated_at,
        translations:experience_translations(
            id,
            language_code,
            title,
            location,
            description,
            skills
        )
    `,
    )
    .eq("id", id)
    .single();

// Redirect if experience not found
if (!experience || fetchError) {
    return Astro.redirect("/admin/dashboard");
}

// User is authenticated and authorized
const userEmail = user.email;
const isNew = Astro.url.searchParams.get("created") === "true";

// Create a map of translations by language code for easy access
const translationsByLang: Record<string, any> = {};
if (experience.translations && Array.isArray(experience.translations)) {
    experience.translations.forEach((t: any) => {
        translationsByLang[t.language_code] = t;
    });
}

// Check if OpenAI API key is configured
const hasOpenAIKey = !!import.meta.env.OPENAI_API_KEY;
---

---

<Layout
    title={`Edit Experience - Admin - ${import.meta.env.SITE_AUTHOR || "Admin"}`}
>
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ← Back to Dashboard
                </a>
                <h1
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-4"
                >
                    Edit Experience
                </h1>
            </div>

            {
                isNew && (
                    <div
                        id="success-message"
                        class="mb-6 rounded-lg bg-green-50 dark:bg-green-900/20 p-4 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800"
                    >
                        Experience created successfully!
                    </div>
                )
            }

            <div
                id="save-success"
                class="mb-6 hidden rounded-lg bg-green-50 dark:bg-green-900/20 p-4 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800"
            >
                Changes saved successfully!
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form
                    id="experience-form"
                    data-experience-id={experience.id}
                    class="space-y-6"
                >
                    <!-- Global Fields Section -->
                    <div
                        class="border-b border-gray-200 dark:border-gray-700 pb-6"
                    >
                        <h2
                            class="text-xl font-bold text-gray-900 dark:text-white mb-4"
                        >
                            Global Information
                        </h2>
                        <div class="space-y-4">
                            <!-- Company -->
                            <div>
                                <label
                                    for="company"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Company/Organization <span
                                        class="text-red-500">*</span
                                    >
                                </label>
                                <input
                                    type="text"
                                    id="company"
                                    name="company"
                                    required
                                    value={experience.company || ""}
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                            </div>

                            <!-- Start Date -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        for="start_month"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Start Month <span class="text-red-500"
                                            >*</span
                                        >
                                    </label>
                                    <select
                                        id="start_month"
                                        name="start_month"
                                        required
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    >
                                        <option value="">Select month</option>
                                        <option
                                            value="1"
                                            selected={experience.start_month ===
                                                1}>January</option
                                        >
                                        <option
                                            value="2"
                                            selected={experience.start_month ===
                                                2}>February</option
                                        >
                                        <option
                                            value="3"
                                            selected={experience.start_month ===
                                                3}>March</option
                                        >
                                        <option
                                            value="4"
                                            selected={experience.start_month ===
                                                4}>April</option
                                        >
                                        <option
                                            value="5"
                                            selected={experience.start_month ===
                                                5}>May</option
                                        >
                                        <option
                                            value="6"
                                            selected={experience.start_month ===
                                                6}>June</option
                                        >
                                        <option
                                            value="7"
                                            selected={experience.start_month ===
                                                7}>July</option
                                        >
                                        <option
                                            value="8"
                                            selected={experience.start_month ===
                                                8}>August</option
                                        >
                                        <option
                                            value="9"
                                            selected={experience.start_month ===
                                                9}>September</option
                                        >
                                        <option
                                            value="10"
                                            selected={experience.start_month ===
                                                10}>October</option
                                        >
                                        <option
                                            value="11"
                                            selected={experience.start_month ===
                                                11}>November</option
                                        >
                                        <option
                                            value="12"
                                            selected={experience.start_month ===
                                                12}>December</option
                                        >
                                    </select>
                                </div>
                                <div>
                                    <label
                                        for="start_year"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Start Year <span class="text-red-500"
                                            >*</span
                                        >
                                    </label>
                                    <input
                                        type="number"
                                        id="start_year"
                                        name="start_year"
                                        required
                                        value={experience.start_year || ""}
                                        min="1990"
                                        max={new Date().getFullYear()}
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>
                            </div>

                            <!-- End Date -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        for="end_month"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        End Month
                                    </label>
                                    <select
                                        id="end_month"
                                        name="end_month"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    >
                                        <option value="">Ongoing</option>
                                        <option
                                            value="1"
                                            selected={experience.end_month ===
                                                1}>January</option
                                        >
                                        <option
                                            value="2"
                                            selected={experience.end_month ===
                                                2}>February</option
                                        >
                                        <option
                                            value="3"
                                            selected={experience.end_month ===
                                                3}>March</option
                                        >
                                        <option
                                            value="4"
                                            selected={experience.end_month ===
                                                4}>April</option
                                        >
                                        <option
                                            value="5"
                                            selected={experience.end_month ===
                                                5}>May</option
                                        >
                                        <option
                                            value="6"
                                            selected={experience.end_month ===
                                                6}>June</option
                                        >
                                        <option
                                            value="7"
                                            selected={experience.end_month ===
                                                7}>July</option
                                        >
                                        <option
                                            value="8"
                                            selected={experience.end_month ===
                                                8}>August</option
                                        >
                                        <option
                                            value="9"
                                            selected={experience.end_month ===
                                                9}>September</option
                                        >
                                        <option
                                            value="10"
                                            selected={experience.end_month ===
                                                10}>October</option
                                        >
                                        <option
                                            value="11"
                                            selected={experience.end_month ===
                                                11}>November</option
                                        >
                                        <option
                                            value="12"
                                            selected={experience.end_month ===
                                                12}>December</option
                                        >
                                    </select>
                                </div>
                                <div>
                                    <label
                                        for="end_year"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        End Year
                                    </label>
                                    <input
                                        type="number"
                                        id="end_year"
                                        name="end_year"
                                        value={experience.end_year || ""}
                                        min="1990"
                                        max={new Date().getFullYear()}
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>
                            </div>

                            <!-- Status -->
                            <div>
                                <label
                                    for="is_published"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Status
                                </label>
                                <select
                                    id="is_published"
                                    name="is_published"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                >
                                    <option
                                        value="draft"
                                        selected={!experience.is_published}
                                        >Draft</option
                                    >
                                    <option
                                        value="published"
                                        selected={experience.is_published}
                                        >Published</option
                                    >
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Language Tabs Section -->
                    <div>
                        <h2
                            class="text-xl font-bold text-gray-900 dark:text-white mb-4"
                        >
                            Translations
                        </h2>

                        {activeLanguages.length > 0 ? (
                            <>
                                <div class="flex gap-2 mb-6 border-b border-gray-200 dark:border-gray-700">
                                    {activeLanguages.map((siteLanguage) => {
                                        const langCode =
                                            siteLanguage.language_code ?? "";
                                        const isDefault =
                                            langCode === defaultLanguageCode;

                                        return (
                                            <button
                                                type="button"
                                                data-lang={langCode}
                                                class={`tab-button px-4 py-2 border-b-2 font-medium text-sm ${
                                                    isDefault
                                                        ? "active border-primary-600 text-primary-600 dark:text-primary-400"
                                                        : "border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300"
                                                }`}
                                            >
                                                {siteLanguage.language_name}
                                            </button>
                                        );
                                    })}
                                </div>

                                {activeLanguages.map((siteLanguage) => {
                                    const langCode =
                                        siteLanguage.language_code ?? "";
                                    const isDefault =
                                        langCode === defaultLanguageCode;
                                    const translation =
                                        translationsByLang[langCode] ?? {};

                                    return (
                                        <div
                                            data-lang={langCode}
                                            class={`tab-content space-y-4 ${
                                                isDefault ? "" : "hidden"
                                            }`}
                                        >
                                            {!isDefault && (
                                                <div class="mb-4 flex gap-2">
                                                    <button
                                                        type="button"
                                                        class="copy-from-default px-4 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 text-sm font-medium transition-colors"
                                                        data-lang={langCode}
                                                    >
                                                        Copy from {defaultLanguageName}
                                                    </button>
                                                    {hasOpenAIKey && (
                                                        <button
                                                            type="button"
                                                            class="translate-btn px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                            data-lang={langCode}
                                                        >
                                                            Translate from {defaultLanguageName}
                                                        </button>
                                                    )}
                                                </div>
                                            )}
                                            <div>
                                                <label
                                                    for={`title_${langCode}`}
                                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                >
                                                    Job Title
                                                    {isDefault && (
                                                        <span class="text-red-500">*</span>
                                                    )}
                                                </label>
                                                <input
                                                    type="text"
                                                    id={`title_${langCode}`}
                                                    name={`title_${langCode}`}
                                                    required={isDefault}
                                                    value={translation?.title || ""}
                                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                />
                                            </div>
                                            <div>
                                                <label
                                                    for={`location_${langCode}`}
                                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                >
                                                    Location
                                                </label>
                                                <input
                                                    type="text"
                                                    id={`location_${langCode}`}
                                                    name={`location_${langCode}`}
                                                    value={translation?.location || ""}
                                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                />
                                            </div>
                                            <div>
                                                <label
                                                    for={`description_${langCode}`}
                                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                >
                                                    Accomplishments/Description
                                                </label>
                                                <textarea
                                                    id={`description_${langCode}`}
                                                    name={`description_${langCode}`}
                                                    rows="4"
                                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                >{(translation?.description || []).join("\n")}</textarea>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                    Enter each accomplishment on a new line.
                                                </p>
                                            </div>
                                            <div>
                                                <label
                                                    for={`skills_${langCode}`}
                                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                >
                                                    Skills/Technologies
                                                </label>
                                                <textarea
                                                    id={`skills_${langCode}`}
                                                    name={`skills_${langCode}`}
                                                    rows="3"
                                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                >{(translation?.skills || []).join(", ")}</textarea>
                                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                                    Comma-separated list of technologies/skills
                                                </p>
                                            </div>
                                        </div>
                                    );
                                })}
                            </>
                        ) : (
                            <div class="text-center py-6 text-gray-500 dark:text-gray-400">
                                No active site languages found. Add and activate languages in the dashboard first.
                            </div>
                        )}
                    </div>

                    <!-- Submit Button -->
                    <div
                        class="flex gap-4 pt-6 border-t border-gray-200 dark:border-gray-700"
                    >
                        <button
                            type="submit"
                            class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
                        >
                            Save Changes
                        </button>
                        <a
                            href="/admin/dashboard"
                            class="px-6 py-2 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors font-medium"
                        >
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="application/json" id="experience-language-data">
        {JSON.stringify({
            activeLanguages: activeLanguages.map((lang) => ({
                code: lang.language_code,
                name: lang.language_name,
            })),
            defaultLanguageCode,
            defaultLanguageName,
        })}
    </script>

    <script>
        type LanguageConfig = {
            activeLanguages: { code?: string | null; name?: string | null }[];
            defaultLanguageCode?: string;
            defaultLanguageName?: string;
        };

        window.addEventListener("DOMContentLoaded", () => {
            const languageConfigEl = document.getElementById(
                "experience-language-data",
            ) as HTMLScriptElement | null;
            const languageConfig: LanguageConfig = languageConfigEl?.textContent
                ? JSON.parse(languageConfigEl.textContent)
                : { activeLanguages: [] };

            const activeLanguages = languageConfig.activeLanguages ?? [];
            const defaultLanguageCode =
                languageConfig.defaultLanguageCode ?? "";
            const defaultLanguageName =
                languageConfig.defaultLanguageName ?? "Default";

            // Tab switching
            const tabButtons = document.querySelectorAll(".tab-button");
            const tabContents = document.querySelectorAll(".tab-content");

            tabButtons.forEach((button) => {
                button.addEventListener("click", () => {
                    const lang = (button as HTMLElement).dataset.lang;
                    if (!lang) return;

                    // Remove active class from all buttons and contents
                    tabButtons.forEach((btn) => {
                        (btn as HTMLElement).classList.remove(
                            "active",
                            "border-b-2",
                            "border-primary-600",
                            "text-primary-600",
                            "dark:text-primary-400",
                        );
                        (btn as HTMLElement).classList.add(
                            "border-b-2",
                            "border-transparent",
                            "text-gray-600",
                            "dark:text-gray-400",
                        );
                    });
                    tabContents.forEach((content) => {
                        (content as HTMLElement).classList.add("hidden");
                    });

                    // Add active class to clicked button and show content
                    (button as HTMLElement).classList.add(
                        "active",
                        "border-b-2",
                        "border-primary-600",
                        "text-primary-600",
                        "dark:text-primary-400",
                    );
                    (button as HTMLElement).classList.remove(
                        "border-b-2",
                        "border-transparent",
                        "text-gray-600",
                        "dark:text-gray-400",
                    );
                    document
                        .querySelector(`.tab-content[data-lang="${lang}"]`)
                        ?.classList.remove("hidden");
                });
            });

            // Copy from default language functionality
            document
                .querySelectorAll(".copy-from-default")
                .forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.preventDefault();
                        const targetLang = (button as HTMLElement).dataset.lang;

                        if (!targetLang || !defaultLanguageCode) return;

                        const sourceTitle = (
                            document.querySelector(
                                `#title_${defaultLanguageCode}`,
                            ) as HTMLInputElement
                        )?.value;
                        const sourceLocation = (
                            document.querySelector(
                                `#location_${defaultLanguageCode}`,
                            ) as HTMLInputElement
                        )?.value;
                        const sourceDescription = (
                            document.querySelector(
                                `#description_${defaultLanguageCode}`,
                            ) as HTMLTextAreaElement
                        )?.value;
                        const sourceSkills = (
                            document.querySelector(
                                `#skills_${defaultLanguageCode}`,
                            ) as HTMLTextAreaElement
                        )?.value;

                        (
                            document.querySelector(
                                `#title_${targetLang}`,
                            ) as HTMLInputElement
                        ).value = sourceTitle;
                        (
                            document.querySelector(
                                `#location_${targetLang}`,
                            ) as HTMLInputElement
                        ).value = sourceLocation;
                        (
                            document.querySelector(
                                `#description_${targetLang}`,
                            ) as HTMLTextAreaElement
                        ).value = sourceDescription;
                        (
                            document.querySelector(
                                `#skills_${targetLang}`,
                            ) as HTMLTextAreaElement
                        ).value = sourceSkills;
                    });
                });

            // Translation functionality
            const translateBtns = document.querySelectorAll(
                ".translate-btn",
            ) as NodeListOf<HTMLButtonElement>;
            translateBtns.forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();

                    const lang = (btn as HTMLElement).dataset.lang;
                    if (!lang) return;

                    const originalText = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = "Translating...";

                    try {
                        // Get default language content
                        const titleSource = (
                            document.querySelector(
                                `#title_${defaultLanguageCode}`,
                            ) as HTMLInputElement
                        )?.value;
                        const locationSource = (
                            document.querySelector(
                                `#location_${defaultLanguageCode}`,
                            ) as HTMLInputElement
                        )?.value;
                        const descriptionSource = (
                            document.querySelector(
                                `#description_${defaultLanguageCode}`,
                            ) as HTMLTextAreaElement
                        )?.value;
                        const skillsSource = (
                            document.querySelector(
                                `#skills_${defaultLanguageCode}`,
                            ) as HTMLTextAreaElement
                        )?.value;

                        if (!titleSource?.trim()) {
                            alert(
                                `${defaultLanguageName} title is required for translation`,
                            );
                            btn.disabled = false;
                            btn.textContent = originalText;
                            return;
                        }

                        // Process arrays for API
                        const descriptionArray = descriptionSource
                            .split("\n")
                            .map((line) => line.trim())
                            .filter((line) => line.length > 0);
                        const skillsArray = skillsSource
                            .split(",")
                            .map((skill) => skill.trim())
                            .filter((skill) => skill.length > 0);

                        // Call translation API
                        const response = await fetch("/api/translate", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                title: titleSource,
                                location: locationSource || null,
                                description: descriptionArray,
                                skills: skillsArray,
                                targetLanguage: lang,
                            }),
                        });

                        if (!response.ok) {
                            const error = (await response.json()) as {
                                message?: string;
                            };
                            throw new Error(
                                error.message || "Translation failed",
                            );
                        }

                        const translated = (await response.json()) as {
                            title: string;
                            location: string | null;
                            description: string[];
                            skills: string[];
                        };

                        // Fill in the translated fields
                        const titleField = document.querySelector(
                            `#title_${lang}`,
                        ) as HTMLInputElement;
                        const locationField = document.querySelector(
                            `#location_${lang}`,
                        ) as HTMLInputElement;
                        const descriptionField = document.querySelector(
                            `#description_${lang}`,
                        ) as HTMLTextAreaElement;
                        const skillsField = document.querySelector(
                            `#skills_${lang}`,
                        ) as HTMLTextAreaElement;

                        if (titleField)
                            titleField.value = translated.title || "";
                        if (locationField)
                            locationField.value = translated.location || "";
                        if (descriptionField)
                            descriptionField.value =
                                translated.description?.join("\n") || "";
                        if (skillsField)
                            skillsField.value =
                                translated.skills?.join(", ") || "";

                        btn.textContent = "✓ Translated!";
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.textContent = originalText;
                        }, 2000);
                    } catch (error) {
                        console.error("Translation error:", error);
                        alert(
                            `Translation failed: ${error instanceof Error ? error.message : "Unknown error"}`,
                        );
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                });
            });

            // Form submission
            const form = document.getElementById("experience-form");
            if (!form) throw new Error("Experience form not found");

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const experienceId = (e.target as HTMLFormElement).dataset
                    .experienceId;

                const translations: Record<string, any> = {};

                // Process each language
                activeLanguages.forEach((language) => {
                    const lang = language.code;
                    if (!lang) return;
                    const title = (
                        document.querySelector(
                            `#title_${lang}`,
                        ) as HTMLInputElement
                    )?.value;
                    const location = (
                        document.querySelector(
                            `#location_${lang}`,
                        ) as HTMLInputElement
                    )?.value;
                    const description = (
                        (
                            document.querySelector(
                                `#description_${lang}`,
                            ) as HTMLTextAreaElement
                        )?.value || ""
                    )
                        .split("\n")
                        .map((line) => line.trim())
                        .filter((line) => line.length > 0);
                    const skills = (
                        (
                            document.querySelector(
                                `#skills_${lang}`,
                            ) as HTMLTextAreaElement
                        )?.value || ""
                    )
                        .split(",")
                        .map((skill) => skill.trim())
                        .filter((skill) => skill.length > 0);

                    if (title) {
                        translations[lang] = {
                            title,
                            location: location || null,
                            description,
                            skills,
                        };
                    }
                });

                if (defaultLanguageCode && !translations[defaultLanguageCode]) {
                    alert(`${defaultLanguageName} title is required`);
                    return;
                }

                const payload = {
                    company: (
                        document.querySelector("#company") as HTMLInputElement
                    )?.value,
                    start_month: parseInt(
                        (
                            document.querySelector(
                                "#start_month",
                            ) as HTMLSelectElement
                        )?.value,
                    ),
                    start_year: parseInt(
                        (
                            document.querySelector(
                                "#start_year",
                            ) as HTMLInputElement
                        )?.value,
                    ),
                    end_month:
                        parseInt(
                            (
                                document.querySelector(
                                    "#end_month",
                                ) as HTMLSelectElement
                            )?.value,
                        ) || null,
                    end_year:
                        parseInt(
                            (
                                document.querySelector(
                                    "#end_year",
                                ) as HTMLInputElement
                            )?.value,
                        ) || null,
                    is_published:
                        (
                            document.querySelector(
                                "#is_published",
                            ) as HTMLSelectElement
                        )?.value === "published",
                    translations,
                };

                try {
                    const response = await fetch(
                        `/api/experiences/${experienceId}`,
                        {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(payload),
                        },
                    );

                    if (!response.ok) {
                        const error = (await response.json()) as {
                            message?: string;
                        };
                        alert(
                            `Error: ${error.message || "Failed to update experience"}`,
                        );
                        return;
                    }

                    // Show success message and redirect after 1.5 seconds
                    const successMessage = document.getElementById(
                        "save-success",
                    );
                    if (successMessage) {
                        successMessage.classList.remove("hidden");
                    }
                    setTimeout(() => {
                        window.location.href = "/admin/dashboard";
                    }, 1500);
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error updating experience");
                }
            });
        });
    </script>
</Layout>
