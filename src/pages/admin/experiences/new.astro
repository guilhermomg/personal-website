---
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import { createServerClient } from "../../../lib/supabase";

const adminGithubUsername = import.meta.env.GITHUB_USERNAME;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

// Get GitHub username from user metadata
const userGithubUsername =
    user.user_metadata?.user_name || user.user_metadata?.preferred_username;

if (userGithubUsername !== adminGithubUsername) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

const { data: siteLanguages } = await supabase
    .from("site_languages")
    .select("language_code, language_name, is_default, is_active")
    .eq("is_active", true)
    .order("language_code", { ascending: true });

const activeLanguages = (siteLanguages ?? []) as {
    language_code?: string | null;
    language_name?: string | null;
    is_default?: boolean | null;
}[];

const defaultLanguage =
    activeLanguages.find((lang) => lang.is_default) ?? activeLanguages[0];
const defaultLanguageCode = defaultLanguage?.language_code ?? "";
const defaultLanguageName = defaultLanguage?.language_name ?? "Default";

// User is authenticated and authorized
const userEmail = user.email;

// Check if OpenAI API key is configured
const hasOpenAIKey = !!import.meta.env.OPENAI_API_KEY;
---

<Layout
    title={`New Experience - Admin - ${import.meta.env.SITE_AUTHOR || "Admin"}`}
>
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ← Back to Dashboard
                </a>
                <h1
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-4"
                >
                    Create New Experience
                </h1>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form id="experience-form" class="space-y-6">
                    <!-- Global Fields Section -->
                    <div
                        class="border-b border-gray-200 dark:border-gray-700 pb-6"
                    >
                        <h2
                            class="text-xl font-bold text-gray-900 dark:text-white mb-4"
                        >
                            Global Information
                        </h2>
                        <div class="space-y-4">
                            <!-- Company -->
                            <div>
                                <label
                                    for="company"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Company/Organization <span
                                        class="text-red-500">*</span
                                    >
                                </label>
                                <input
                                    type="text"
                                    id="company"
                                    name="company"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                            </div>

                            <!-- Start Date -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        for="start_month"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Start Month <span class="text-red-500"
                                            >*</span
                                        >
                                    </label>
                                    <select
                                        id="start_month"
                                        name="start_month"
                                        required
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    >
                                        <option value="">Select month</option>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        for="start_year"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Start Year <span class="text-red-500"
                                            >*</span
                                        >
                                    </label>
                                    <input
                                        type="number"
                                        id="start_year"
                                        name="start_year"
                                        required
                                        min="1990"
                                        max={new Date().getFullYear()}
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>
                            </div>

                            <!-- End Date -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        for="end_month"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        End Month
                                    </label>
                                    <select
                                        id="end_month"
                                        name="end_month"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    >
                                        <option value="">Ongoing</option>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        for="end_year"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        End Year
                                    </label>
                                    <input
                                        type="number"
                                        id="end_year"
                                        name="end_year"
                                        min="1990"
                                        max={new Date().getFullYear()}
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>
                            </div>

                            <!-- Status -->
                            <div>
                                <label
                                    for="is_published"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Status
                                </label>
                                <select
                                    id="is_published"
                                    name="is_published"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="draft">Draft</option>
                                    <option value="published">Published</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Language Tabs Section -->
                    <div>
                        <h2
                            class="text-xl font-bold text-gray-900 dark:text-white mb-4"
                        >
                            Translations
                        </h2>

                        {
                            activeLanguages.length > 0 ? (
                                <>
                                    <div class="flex gap-2 mb-6 border-b border-gray-200 dark:border-gray-700">
                                        {activeLanguages.map((siteLanguage) => {
                                            const langCode =
                                                siteLanguage.language_code ??
                                                "";
                                            const isDefault =
                                                langCode ===
                                                defaultLanguageCode;

                                            return (
                                                <button
                                                    type="button"
                                                    data-lang={langCode}
                                                    class={`tab-button px-4 py-2 border-b-2 font-medium text-sm ${
                                                        isDefault
                                                            ? "active border-primary-600 text-primary-600 dark:text-primary-400"
                                                            : "border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-300"
                                                    }`}
                                                >
                                                    {siteLanguage.language_name}
                                                </button>
                                            );
                                        })}
                                    </div>

                                    {activeLanguages.map((siteLanguage) => {
                                        const langCode =
                                            siteLanguage.language_code ?? "";
                                        const isDefault =
                                            langCode === defaultLanguageCode;

                                        return (
                                            <div
                                                data-lang={langCode}
                                                class={`tab-content space-y-4 ${
                                                    isDefault ? "" : "hidden"
                                                }`}
                                            >
                                                {!isDefault && (
                                                    <div class="mb-4 flex gap-2">
                                                        <button
                                                            type="button"
                                                            class="copy-from-default px-4 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 text-sm font-medium transition-colors"
                                                            data-lang={langCode}
                                                        >
                                                            Copy from{" "}
                                                            {
                                                                defaultLanguageName
                                                            }
                                                        </button>
                                                        {hasOpenAIKey && (
                                                            <button
                                                                type="button"
                                                                class="translate-btn px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                                data-lang={
                                                                    langCode
                                                                }
                                                            >
                                                                Translate from{" "}
                                                                {
                                                                    defaultLanguageName
                                                                }
                                                            </button>
                                                        )}
                                                    </div>
                                                )}
                                                <div>
                                                    <label
                                                        for={`title_${langCode}`}
                                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                    >
                                                        Job Title
                                                        {isDefault && (
                                                            <span class="text-red-500">
                                                                *
                                                            </span>
                                                        )}
                                                    </label>
                                                    <input
                                                        type="text"
                                                        id={`title_${langCode}`}
                                                        name={`title_${langCode}`}
                                                        required={isDefault}
                                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                    />
                                                </div>
                                                <div>
                                                    <label
                                                        for={`location_${langCode}`}
                                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                    >
                                                        Location
                                                    </label>
                                                    <input
                                                        type="text"
                                                        id={`location_${langCode}`}
                                                        name={`location_${langCode}`}
                                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                    />
                                                </div>
                                                <div>
                                                    <label
                                                        for={`description_${langCode}`}
                                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                    >
                                                        Description (one per
                                                        line)
                                                    </label>
                                                    <textarea
                                                        id={`description_${langCode}`}
                                                        name={`description_${langCode}`}
                                                        rows={4}
                                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                    />
                                                </div>
                                                <div>
                                                    <label
                                                        for={`skills_${langCode}`}
                                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                                    >
                                                        Skills (comma-separated)
                                                    </label>
                                                    <textarea
                                                        id={`skills_${langCode}`}
                                                        name={`skills_${langCode}`}
                                                        rows={2}
                                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                                    />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </>
                            ) : (
                                <p class="text-gray-600 dark:text-gray-400">
                                    No active languages configured.
                                </p>
                            )
                        }
                    </div>

                    <!-- Action Buttons -->
                    <div
                        class="flex justify-between pt-6 border-t border-gray-200 dark:border-gray-700"
                    >
                        <a
                            href="/admin/dashboard"
                            class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 font-medium transition-colors"
                        >
                            Cancel
                        </a>
                        <button
                            type="submit"
                            class="px-6 py-2 bg-primary-600 dark:bg-primary-700 text-white rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600 font-medium transition-colors"
                        >
                            Create Experience
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</Layout>

<script>
    window.addEventListener("DOMContentLoaded", () => {
        // Reconstruct active languages from the DOM tabs
        const tabButtons = document.querySelectorAll(
            ".tab-button",
        ) as NodeListOf<HTMLElement>;
        const activeLanguages: { language_code: string }[] = [];
        tabButtons.forEach((btn) => {
            const lang = btn.dataset.lang;
            if (lang) {
                activeLanguages.push({
                    language_code: lang,
                });
            }
        });

        const defaultLanguageCode = activeLanguages[0]?.language_code || "";

        // Tab switching functionality
        const tabButtons2 = document.querySelectorAll(
            ".tab-button",
        ) as NodeListOf<HTMLButtonElement>;
        const tabContents = document.querySelectorAll(
            ".tab-content",
        ) as NodeListOf<HTMLElement>;

        tabButtons2.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const targetLang = btn.dataset.lang;

                // Update active tab button
                tabButtons2.forEach((b) =>
                    b.classList.remove(
                        "active",
                        "border-primary-600",
                        "text-primary-600",
                        "dark:text-primary-400",
                    ),
                );
                btn.classList.add(
                    "active",
                    "border-primary-600",
                    "text-primary-600",
                    "dark:text-primary-400",
                );

                // Update visible content
                tabContents.forEach((content) => {
                    if (content.dataset.lang === targetLang) {
                        content.classList.remove("hidden");
                    } else {
                        content.classList.add("hidden");
                    }
                });
            });
        });

        // Copy from default language
        const copyButtons = document.querySelectorAll(
            ".copy-from-default",
        ) as NodeListOf<HTMLButtonElement>;
        copyButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const targetLang = btn.dataset.lang;

                const defaultTitle = (
                    document.querySelector(
                        `#title_${defaultLanguageCode}`,
                    ) as HTMLInputElement
                )?.value;
                const defaultLocation = (
                    document.querySelector(
                        `#location_${defaultLanguageCode}`,
                    ) as HTMLInputElement
                )?.value;
                const defaultDescription = (
                    document.querySelector(
                        `#description_${defaultLanguageCode}`,
                    ) as HTMLTextAreaElement
                )?.value;
                const defaultSkills = (
                    document.querySelector(
                        `#skills_${defaultLanguageCode}`,
                    ) as HTMLTextAreaElement
                )?.value;

                const titleField = document.querySelector(
                    `#title_${targetLang}`,
                ) as HTMLInputElement;
                const locationField = document.querySelector(
                    `#location_${targetLang}`,
                ) as HTMLInputElement;
                const descriptionField = document.querySelector(
                    `#description_${targetLang}`,
                ) as HTMLTextAreaElement;
                const skillsField = document.querySelector(
                    `#skills_${targetLang}`,
                ) as HTMLTextAreaElement;

                if (titleField) titleField.value = defaultTitle || "";
                if (locationField) locationField.value = defaultLocation || "";
                if (descriptionField)
                    descriptionField.value = defaultDescription || "";
                if (skillsField) skillsField.value = defaultSkills || "";
            });
        });

        // Translation functionality
        const translateButtons = document.querySelectorAll(
            ".translate-btn",
        ) as NodeListOf<HTMLButtonElement>;
        translateButtons.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                const targetLang = btn.dataset.lang;
                const originalText = btn.textContent;

                btn.disabled = true;
                btn.textContent = "Translating...";

                try {
                    const defaultTitle = (
                        document.querySelector(
                            `#title_${defaultLanguageCode}`,
                        ) as HTMLInputElement
                    )?.value;
                    const defaultLocation = (
                        document.querySelector(
                            `#location_${defaultLanguageCode}`,
                        ) as HTMLInputElement
                    )?.value;
                    const defaultDescription = (
                        (
                            document.querySelector(
                                `#description_${defaultLanguageCode}`,
                            ) as HTMLTextAreaElement
                        )?.value || ""
                    )
                        .split("\n")
                        .filter((line) => line.trim());
                    const defaultSkills = (
                        (
                            document.querySelector(
                                `#skills_${defaultLanguageCode}`,
                            ) as HTMLTextAreaElement
                        )?.value || ""
                    )
                        .split(",")
                        .map((skill) => skill.trim());

                    const response = await fetch("/api/translate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            sourceLanguage: defaultLanguageCode,
                            targetLanguage: targetLang,
                            title: defaultTitle,
                            location: defaultLocation,
                            description: defaultDescription,
                            skills: defaultSkills,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const translated = (await response.json()) as {
                        title?: string;
                        location?: string;
                        description?: string[];
                        skills?: string[];
                    };

                    const titleField = document.querySelector(
                        `#title_${targetLang}`,
                    ) as HTMLInputElement;
                    const locationField = document.querySelector(
                        `#location_${targetLang}`,
                    ) as HTMLInputElement;
                    const descriptionField = document.querySelector(
                        `#description_${targetLang}`,
                    ) as HTMLTextAreaElement;
                    const skillsField = document.querySelector(
                        `#skills_${targetLang}`,
                    ) as HTMLTextAreaElement;

                    if (titleField) titleField.value = translated.title || "";
                    if (locationField)
                        locationField.value = translated.location || "";
                    if (descriptionField)
                        descriptionField.value =
                            translated.description?.join("\n") || "";
                    if (skillsField)
                        skillsField.value = translated.skills?.join(", ") || "";

                    btn.textContent = "✓ Translated!";
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    console.error("Translation error:", error);
                    alert(
                        `Translation failed: ${error instanceof Error ? error.message : "Unknown error"}`,
                    );
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });
        });

        // Form submission
        const form = document.getElementById("experience-form");
        if (!form) throw new Error("Experience form not found");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const translations: Record<string, any> = {};

            // Process each language
            activeLanguages.forEach((language) => {
                const lang = language.language_code;
                if (!lang) return;
                const title = (
                    document.querySelector(`#title_${lang}`) as HTMLInputElement
                )?.value;
                const location = (
                    document.querySelector(
                        `#location_${lang}`,
                    ) as HTMLInputElement
                )?.value;
                const description = (
                    (
                        document.querySelector(
                            `#description_${lang}`,
                        ) as HTMLTextAreaElement
                    )?.value || ""
                )
                    .split("\n")
                    .map((line) => line.trim())
                    .filter((line) => line.length > 0);
                const skills = (
                    (
                        document.querySelector(
                            `#skills_${lang}`,
                        ) as HTMLTextAreaElement
                    )?.value || ""
                )
                    .split(",")
                    .map((skill) => skill.trim())
                    .filter((skill) => skill.length > 0);

                if (title) {
                    translations[lang] = {
                        title,
                        location: location || null,
                        description,
                        skills,
                    };
                }
            });

            if (defaultLanguageCode && !translations[defaultLanguageCode]) {
                alert(`Default language title is required`);
                return;
            }

            const payload = {
                company: (
                    document.querySelector("#company") as HTMLInputElement
                )?.value,
                start_month: parseInt(
                    (
                        document.querySelector(
                            "#start_month",
                        ) as HTMLSelectElement
                    )?.value,
                ),
                start_year: parseInt(
                    (document.querySelector("#start_year") as HTMLInputElement)
                        ?.value,
                ),
                end_month:
                    parseInt(
                        (
                            document.querySelector(
                                "#end_month",
                            ) as HTMLSelectElement
                        )?.value,
                    ) || null,
                end_year:
                    parseInt(
                        (
                            document.querySelector(
                                "#end_year",
                            ) as HTMLInputElement
                        )?.value,
                    ) || null,
                is_published:
                    (
                        document.querySelector(
                            "#is_published",
                        ) as HTMLSelectElement
                    )?.value === "published",
                translations,
            };

            try {
                const response = await fetch("/api/experiences", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const error = (await response.json()) as {
                        message?: string;
                    };
                    alert(
                        `Error: ${error.message || "Failed to create experience"}`,
                    );
                    return;
                }

                const result = (await response.json()) as { id: string };
                window.location.href = `/admin/experiences/${result.id}/edit?created=true`;
            } catch (error) {
                console.error("Error:", error);
                alert("Error creating experience");
            }
        });
    });
</script>
