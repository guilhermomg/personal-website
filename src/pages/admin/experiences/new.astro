---
export const prerender = false;

import Layout from "../../../layouts/Layout.astro";
import { createServerClient } from "../../../lib/supabase";

const adminGithubUsername = import.meta.env.GITHUB_USERNAME;

const supabase = createServerClient(Astro.cookies);
const {
    data: { user },
    error,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user || error) {
    return Astro.redirect("/admin/login");
}

// Get GitHub username from user metadata
const userGithubUsername =
    user.user_metadata?.user_name || user.user_metadata?.preferred_username;

if (userGithubUsername !== adminGithubUsername) {
    // Sign out and redirect
    await supabase.auth.signOut();
    return Astro.redirect("/admin/login?error=unauthorized");
}

// User is authenticated and authorized
const userEmail = user.email;

// Check if OpenAI API key is configured
const hasOpenAIKey = !!import.meta.env.OPENAI_API_KEY;
---

<Layout
    title={`New Experience - Admin - ${import.meta.env.SITE_AUTHOR || "Admin"}`}
>
    <div
        class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800"
    >
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-8">
                <a
                    href="/admin/dashboard"
                    class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300"
                >
                    ← Back to Dashboard
                </a>
                <h1
                    class="text-3xl font-bold text-gray-900 dark:text-white mt-4"
                >
                    Create New Experience
                </h1>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-8">
                <form id="experience-form" class="space-y-6">
                    <!-- Global Fields -->
                    <div
                        class="bg-gray-50 dark:bg-gray-900/50 p-6 rounded-lg border border-gray-200 dark:border-gray-700"
                    >
                        <h2
                            class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
                        >
                            General Information
                        </h2>

                        <!-- Company -->
                        <div class="mb-4">
                            <label
                                for="company"
                                class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                            >
                                Company/Organization <span class="text-red-500"
                                    >*</span
                                >
                            </label>
                            <input
                                type="text"
                                id="company"
                                name="company"
                                required
                                placeholder="e.g., Microsoft"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                            />
                        </div>

                        <!-- Dates Grid -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    for="start_month"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Start Month <span class="text-red-500"
                                        >*</span
                                    >
                                </label>
                                <select
                                    id="start_month"
                                    name="start_month"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="">Select month</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    for="start_year"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    Start Year <span class="text-red-500"
                                        >*</span
                                    >
                                </label>
                                <input
                                    type="number"
                                    id="start_year"
                                    name="start_year"
                                    required
                                    min="1990"
                                    max={new Date().getFullYear()}
                                    placeholder={new Date()
                                        .getFullYear()
                                        .toString()}
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label
                                    for="end_month"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    End Month
                                </label>
                                <select
                                    id="end_month"
                                    name="end_month"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value=""
                                        >Leave empty for Present</option
                                    >
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    for="end_year"
                                    class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                >
                                    End Year
                                </label>
                                <input
                                    type="number"
                                    id="end_year"
                                    name="end_year"
                                    min="1990"
                                    max={new Date().getFullYear()}
                                    placeholder="Leave empty for Present"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                />
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mt-4">
                            <label
                                for="is_published"
                                class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                            >
                                Status
                            </label>
                            <select
                                id="is_published"
                                name="is_published"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500"
                            >
                                <option value="draft">Draft</option>
                                <option value="published" selected
                                    >Published</option
                                >
                            </select>
                        </div>
                    </div>

                    <!-- Language Tabs -->
                    <div>
                        <h2
                            class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
                        >
                            Translations
                        </h2>

                        <!-- Tab Buttons -->
                        <div
                            class="flex gap-2 mb-6 border-b border-gray-200 dark:border-gray-700"
                        >
                            <button
                                type="button"
                                class="tab-btn px-4 py-2 font-medium text-sm border-b-2 border-primary-600 text-primary-600 dark:text-primary-400"
                                data-lang="en"
                            >
                                English (EN)
                            </button>
                            <button
                                type="button"
                                class="tab-btn px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"
                                data-lang="fr"
                            >
                                Français (FR)
                            </button>
                            <button
                                type="button"
                                class="tab-btn px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"
                                data-lang="pt"
                            >
                                Português (PT)
                            </button>
                        </div>

                        <!-- Tab Content -->
                        <div class="space-y-4">
                            <!-- EN Tab -->
                            <div class="tab-content" data-lang="en">
                                <div>
                                    <label
                                        for="title-en"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Job Title <span class="text-red-500"
                                            >*</span
                                        >
                                    </label>
                                    <input
                                        type="text"
                                        id="title-en"
                                        name="title-en"
                                        required
                                        placeholder="e.g., Senior Full Stack Developer"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="location-en"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Location
                                    </label>
                                    <input
                                        type="text"
                                        id="location-en"
                                        name="location-en"
                                        placeholder="e.g., Canada"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="description-en"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Accomplishments/Description
                                    </label>
                                    <textarea
                                        id="description-en"
                                        name="description-en"
                                        rows="4"
                                        placeholder="Enter each accomplishment on a new line"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    ></textarea>
                                    <p
                                        class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                                    >
                                        One item per line
                                    </p>
                                </div>

                                <div>
                                    <label
                                        for="skills-en"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Skills/Technologies
                                    </label>
                                    <textarea
                                        id="skills-en"
                                        name="skills-en"
                                        rows="3"
                                        placeholder="Node.js, React, TypeScript, AWS"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    ></textarea>
                                    <p
                                        class="text-xs text-gray-600 dark:text-gray-400 mt-1"
                                    >
                                        Comma-separated list
                                    </p>
                                </div>
                            </div>

                            <!-- FR Tab -->
                            <div class="tab-content hidden" data-lang="fr">
                                <div class="mb-4 flex gap-2">
                                    <button
                                        type="button"
                                        class="copy-from-en-btn px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 rounded hover:bg-blue-200 dark:hover:bg-blue-900/60"
                                    >
                                        Copy from English
                                    </button>
                                    {
                                        hasOpenAIKey && (
                                            <button
                                                type="button"
                                                class="translate-btn px-3 py-1 text-sm bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400 rounded hover:bg-green-200 dark:hover:bg-green-900/60 disabled:opacity-50 disabled:cursor-not-allowed"
                                                data-lang="fr"
                                            >
                                                Translate from English
                                            </button>
                                        )
                                    }
                                </div>

                                <div>
                                    <label
                                        for="title-fr"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Job Title
                                    </label>
                                    <input
                                        type="text"
                                        id="title-fr"
                                        name="title-fr"
                                        placeholder="e.g., Développeur Full Stack Senior"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="location-fr"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Location
                                    </label>
                                    <input
                                        type="text"
                                        id="location-fr"
                                        name="location-fr"
                                        placeholder="e.g., Canada"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="description-fr"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Accomplishments/Description
                                    </label>
                                    <textarea
                                        id="description-fr"
                                        name="description-fr"
                                        rows="4"
                                        placeholder="One item per line"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    ></textarea>
                                </div>

                                <div>
                                    <label
                                        for="skills-fr"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Skills/Technologies
                                    </label>
                                    <textarea
                                        id="skills-fr"
                                        name="skills-fr"
                                        rows="3"
                                        placeholder="Comma-separated list"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    ></textarea>
                                </div>
                            </div>

                            <!-- PT Tab -->
                            <div class="tab-content hidden" data-lang="pt">
                                <div class="mb-4 flex gap-2">
                                    <button
                                        type="button"
                                        class="copy-from-en-btn px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 rounded hover:bg-blue-200 dark:hover:bg-blue-900/60"
                                    >
                                        Copy from English
                                    </button>
                                    {
                                        hasOpenAIKey && (
                                            <button
                                                type="button"
                                                class="translate-btn px-3 py-1 text-sm bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-400 rounded hover:bg-green-200 dark:hover:bg-green-900/60 disabled:opacity-50 disabled:cursor-not-allowed"
                                                data-lang="pt"
                                            >
                                                Translate from English
                                            </button>
                                        )
                                    }
                                </div>

                                <div>
                                    <label
                                        for="title-pt"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Job Title
                                    </label>
                                    <input
                                        type="text"
                                        id="title-pt"
                                        name="title-pt"
                                        placeholder="e.g., Desenvolvedor Full Stack Sênior"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="location-pt"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Location
                                    </label>
                                    <input
                                        type="text"
                                        id="location-pt"
                                        name="location-pt"
                                        placeholder="e.g., Canadá"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    />
                                </div>

                                <div>
                                    <label
                                        for="description-pt"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Accomplishments/Description
                                    </label>
                                    <textarea
                                        id="description-pt"
                                        name="description-pt"
                                        rows="4"
                                        placeholder="One item per line"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    ></textarea>
                                </div>

                                <div>
                                    <label
                                        for="skills-pt"
                                        class="block text-sm font-semibold text-gray-900 dark:text-white mb-2"
                                    >
                                        Skills/Technologies
                                    </label>
                                    <textarea
                                        id="skills-pt"
                                        name="skills-pt"
                                        rows="3"
                                        placeholder="Comma-separated list"
                                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div
                        class="flex gap-4 pt-6 border-t border-gray-200 dark:border-gray-700"
                    >
                        <button
                            type="submit"
                            class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
                        >
                            Create Experience
                        </button>
                        <a
                            href="/admin/dashboard"
                            class="px-6 py-2 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors font-medium"
                        >
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        const tabBtns = document.querySelectorAll(
            ".tab-btn",
        ) as NodeListOf<HTMLButtonElement>;
        const tabContents = document.querySelectorAll(
            ".tab-content",
        ) as NodeListOf<HTMLDivElement>;

        tabBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                const lang = btn.dataset.lang;

                // Update active tab button
                tabBtns.forEach((b) => {
                    b.classList.remove(
                        "border-primary-600",
                        "text-primary-600",
                        "dark:text-primary-400",
                    );
                    b.classList.add(
                        "border-transparent",
                        "text-gray-600",
                        "dark:text-gray-400",
                    );
                });
                btn.classList.remove(
                    "border-transparent",
                    "text-gray-600",
                    "dark:text-gray-400",
                );
                btn.classList.add(
                    "border-primary-600",
                    "text-primary-600",
                    "dark:text-primary-400",
                );

                // Show active tab content
                tabContents.forEach((content) => {
                    if (content.dataset.lang === lang) {
                        content.classList.remove("hidden");
                    } else {
                        content.classList.add("hidden");
                    }
                });
            });
        });

        // Copy from EN functionality
        const copyBtns = document.querySelectorAll(
            ".copy-from-en-btn",
        ) as NodeListOf<HTMLButtonElement>;
        copyBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const tabContent = btn.closest(
                    ".tab-content",
                ) as HTMLDivElement;
                const lang = tabContent?.dataset.lang;

                // Get values from EN fields
                const titleEn = (
                    document.getElementById("title-en") as HTMLInputElement
                )?.value;
                const locationEn = (
                    document.getElementById("location-en") as HTMLInputElement
                )?.value;
                const descriptionEn = (
                    document.getElementById(
                        "description-en",
                    ) as HTMLTextAreaElement
                )?.value;
                const skillsEn = (
                    document.getElementById("skills-en") as HTMLTextAreaElement
                )?.value;

                // Set values to current language fields
                if (lang) {
                    const titleField = document.getElementById(
                        `title-${lang}`,
                    ) as HTMLInputElement;
                    const locationField = document.getElementById(
                        `location-${lang}`,
                    ) as HTMLInputElement;
                    const descriptionField = document.getElementById(
                        `description-${lang}`,
                    ) as HTMLTextAreaElement;
                    const skillsField = document.getElementById(
                        `skills-${lang}`,
                    ) as HTMLTextAreaElement;

                    if (titleField) titleField.value = titleEn;
                    if (locationField) locationField.value = locationEn;
                    if (descriptionField)
                        descriptionField.value = descriptionEn;
                    if (skillsField) skillsField.value = skillsEn;
                }
            });
        });

        // Translation functionality
        const translateBtns = document.querySelectorAll(
            ".translate-btn",
        ) as NodeListOf<HTMLButtonElement>;
        translateBtns.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();

                const lang = btn.dataset.lang;
                if (!lang) return;

                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = "Translating...";

                try {
                    // Get English content
                    const titleEn = (
                        document.getElementById("title-en") as HTMLInputElement
                    )?.value;
                    const locationEn = (
                        document.getElementById(
                            "location-en",
                        ) as HTMLInputElement
                    )?.value;
                    const descriptionEn = (
                        document.getElementById(
                            "description-en",
                        ) as HTMLTextAreaElement
                    )?.value;
                    const skillsEn = (
                        document.getElementById(
                            "skills-en",
                        ) as HTMLTextAreaElement
                    )?.value;

                    if (!titleEn?.trim()) {
                        alert("English title is required for translation");
                        btn.disabled = false;
                        btn.textContent = originalText;
                        return;
                    }

                    // Process arrays for API
                    const descriptionArray = descriptionEn
                        .split("\n")
                        .map((line) => line.trim())
                        .filter((line) => line.length > 0);
                    const skillsArray = skillsEn
                        .split(",")
                        .map((skill) => skill.trim())
                        .filter((skill) => skill.length > 0);

                    // Call translation API
                    const response = await fetch("/api/translate", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            title: titleEn,
                            location: locationEn || null,
                            description: descriptionArray,
                            skills: skillsArray,
                            targetLanguage: lang,
                        }),
                    });

                    if (!response.ok) {
                        const error = (await response.json()) as {
                            message?: string;
                        };
                        throw new Error(error.message || "Translation failed");
                    }

                    const translated = (await response.json()) as {
                        title: string;
                        location: string | null;
                        description: string[];
                        skills: string[];
                    };

                    // Fill in the translated fields
                    const titleField = document.getElementById(
                        `title-${lang}`,
                    ) as HTMLInputElement;
                    const locationField = document.getElementById(
                        `location-${lang}`,
                    ) as HTMLInputElement;
                    const descriptionField = document.getElementById(
                        `description-${lang}`,
                    ) as HTMLTextAreaElement;
                    const skillsField = document.getElementById(
                        `skills-${lang}`,
                    ) as HTMLTextAreaElement;

                    if (titleField) titleField.value = translated.title || "";
                    if (locationField)
                        locationField.value = translated.location || "";
                    if (descriptionField)
                        descriptionField.value =
                            translated.description?.join("\n") || "";
                    if (skillsField)
                        skillsField.value = translated.skills?.join(", ") || "";

                    btn.textContent = "✓ Translated!";
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                } catch (error) {
                    console.error("Translation error:", error);
                    alert(
                        `Translation failed: ${error instanceof Error ? error.message : "Unknown error"}`,
                    );
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            });
        });

        // Form submission
        const form = document.getElementById("experience-form");
        if (!form) throw new Error("Experience form not found");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target as HTMLFormElement);

            // Helper to process text array fields
            const processArray = (text: string) =>
                text
                    .split("\n")
                    .map((line) => line.trim())
                    .filter((line) => line.length > 0);

            // Helper to process comma-separated fields
            const processCommaArray = (text: string) =>
                text
                    .split(",")
                    .map((item) => item.trim())
                    .filter((item) => item.length > 0);

            // Collect translations
            const translations: Record<string, any> = {};
            ["en", "fr", "pt"].forEach((lang) => {
                const title = formData.get(`title-${lang}`) as string;
                if (title?.trim()) {
                    translations[lang] = {
                        title: title,
                        location:
                            (formData.get(`location-${lang}`) as string) ||
                            null,
                        description: processArray(
                            formData.get(`description-${lang}`) as string,
                        ),
                        skills: processCommaArray(
                            formData.get(`skills-${lang}`) as string,
                        ),
                    };
                }
            });

            // Ensure at least English is provided
            if (!translations.en) {
                alert("English (EN) title is required");
                return;
            }

            const payload = {
                company: formData.get("company"),
                start_month: parseInt(formData.get("start_month") as string),
                start_year: parseInt(formData.get("start_year") as string),
                end_month: formData.get("end_month")
                    ? parseInt(formData.get("end_month") as string)
                    : null,
                end_year: formData.get("end_year")
                    ? parseInt(formData.get("end_year") as string)
                    : null,
                is_published: formData.get("is_published") === "published",
                translations,
            };

            try {
                const response = await fetch("/api/experiences", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const error = (await response.json()) as {
                        message?: string;
                    };
                    alert(
                        `Error: ${error.message || "Failed to create experience"}`,
                    );
                    return;
                }

                const result = (await response.json()) as { id: string };
                window.location.href = `/admin/experiences/${result.id}/edit?created=true`;
            } catch (error) {
                console.error("Error:", error);
                alert("Error creating experience");
            }
        });
    </script>
</Layout>
