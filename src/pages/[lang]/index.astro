---
import Layout from "../../layouts/Layout.astro";
import Navigation from "../../components/Navigation.astro";
import Hero from "../../components/Hero.astro";
import About from "../../components/About.astro";
import Experience from "../../components/Experience.astro";
import Projects from "../../components/Projects.astro";
import LatestArticles from "../../components/LatestArticles.astro";
import Contact from "../../components/Contact.astro";
import Footer from "../../components/Footer.astro";
import { getLangFromUrl } from "../../i18n/utils";
import { supabase } from "../../lib/supabase";
import { languages, defaultLang } from "../../i18n/config";

export async function getStaticPaths() {
    // Generate paths for all languages except the default one
    return Object.keys(languages)
        .filter((lang) => lang !== defaultLang)
        .map((lang) => ({
            params: { lang },
        }));
}

const lang = Astro.params.lang || defaultLang;

// Fetch personal info for title/SEO
const { data: personalInfo } = await supabase
    .from("personal_info")
    .select("full_name, seo_description, seo_keywords")
    .single();

const { data: titleTranslation } = await supabase
    .from("personal_info_translations")
    .select("title")
    .eq("language_code", lang)
    .single();

const siteAuthor = personalInfo?.full_name || "Developer";
const siteTitle = titleTranslation?.title || "";
const siteDescription = personalInfo?.seo_description || "";
const siteKeywords = personalInfo?.seo_keywords || "";

const pageTitle = siteTitle ? `${siteAuthor} - ${siteTitle}` : siteAuthor;

// Fetch published projects for SEO
const { data: projects } = await supabase
    .from("projects")
    .select("id, name, description, tags, link, github_link")
    .eq("status", "published")
    .order("order", { ascending: true });

// Extract unique tags from all projects for SEO keywords
const projectTags = projects
    ? Array.from(new Set(projects.flatMap((p) => p.tags || [])))
    : [];

// Add project tags to keywords
const enhancedKeywords =
    projectTags.length > 0
        ? [siteKeywords, projectTags.join(", ")].filter(Boolean).join(", ")
        : siteKeywords;

// Create structured data for projects
const projectsStructuredData =
    projects && projects.length > 0
        ? projects.map((project) => ({
              "@type": "CreativeWork",
              name: project.name,
              description: project.description,
              url: project.link || project.github_link,
              author: {
                  "@type": "Person",
                  name: siteAuthor,
              },
              keywords: project.tags?.join(", "),
              ...(project.github_link && {
                  codeRepository: project.github_link,
              }),
          }))
        : [];

// Determine canonical URL
const canonicalPath = lang === defaultLang ? "/" : `/${lang}/`;
---

<Layout
    title={pageTitle}
    description={siteDescription}
    keywords={enhancedKeywords}
    author={siteAuthor}
    projects={projectsStructuredData}
    canonical={canonicalPath}
>
    <Navigation />
    <main>
        <Hero />
        <About />
        <Experience />
        <Projects />
        <LatestArticles />
        <Contact />
    </main>
    <Footer />
</Layout>

<style>
    /* Smooth scrolling for the entire page */
    html {
        scroll-behavior: smooth;
    }

    /* Custom scrollbar for webkit browsers */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
